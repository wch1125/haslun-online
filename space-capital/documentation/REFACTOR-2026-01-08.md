# ARCHITECTURE REFACTOR - 2026-01-08

## Summary

This refactor addresses structural and UX issues identified in the ChatGPT review. The changes follow three core principles:

1. **Metrics-first data model** - Store normalized scalars, derive semantic labels at render time
2. **Derived instability** - Instability is computed from variance + options + clustering, never declared
3. **Mobile-native UX** - Full-screen horizontal swipe on mobile, not bolted-on CSS hacks

---

## Changes Made

### 1. Trade Loader Refactor (`js/data/load-trades.js`)

#### Before
```js
personality: {
  age: 'veteran',
  damage: 'worn',
  complexity: 'mixed',
  activity: 'hyperactive',
  conviction: 'desperate'
}
```

#### After
```js
metrics: {
  tradeDays: 45,
  pnlRatio: -0.32,
  optionRatio: 0.15,
  tradesPerDay: 18.4,
  expiryDensity: 0.3,
  instability: 0.52,    // DERIVED from variance + options + clustering
  damageScore: 0.35,
  hullIntegrity: 0.65,
  // ... more normalized scalars
}
```

#### Why This Matters
- **Animation intensity** now pulls from `metrics.instability` directly
- **Watercolor glazes** can use `metrics.damageScore` for tint intensity
- **Combat modifiers** derive from `metrics.optionRatio` for aggression
- **No semantic contradictions** - language is derived at render time only

#### New API Functions
- `describeShip(metrics)` - UI presentation mapper, call at render time
- `groupExpiries(trades, ticker)` - Expiries by date for haunting effects
- `getLoomingExpiries(ticker, daysAhead)` - Upcoming expiries for visual effects
- `invalidateCache()` - Force cache refresh

---

### 2. Dossier Caching

Dossiers are now cached after initial computation:

```js
const dossierCache = new Map();
const expiryCache = new Map();

function buildTradeSummary(trades) {
  // Check cache first
  const hash = computeTradeHash(trades);
  if (hash === lastTradeHash && dossierCache.size > 0) {
    console.log('[TradeLoader] Using cached dossiers');
    return { /* ... from cache ... */ };
  }
  // ... compute and cache ...
}
```

This prevents expensive recomputation on every hangar render.

---

### 3. Mobile Swipe Mode (`css/ship-select.css` + `js/ui/ship-select.js`)

#### Behavior
- **Desktop**: Existing grid/list layout, vertical scroll
- **Mobile** (≤768px): Full-screen cards, horizontal swipe

#### Features
- One ship fills the viewport
- MACD + ship feel immersive
- Swipe left/right to cycle ships
- No accidental scroll bleed
- Indicator dots with tap-to-navigate
- First-visit swipe hint
- Edge resistance prevents overscroll

#### Implementation
```js
// In ship-select.html init()
ShipSelect.initSwipeMode(container, selectedTicker);

// New exports
ShipSelect.initSwipeMode(container, selectedTicker)
ShipSelect.disableSwipeMode()
ShipSelect.goToShip(index)
ShipSelect.getCurrentShipIndex()
ShipSelect.getCurrentShipTicker()
ShipSelect.isMobileViewport()
```

---

## File Structure Verification

### ✅ Correct Structure
```
/data/
  guest/
    trade-confirms.csv    ← Canonical Guest CSV (data, not assets)
  telemetry/
    fleet.json
    manifest.json
  stats.json
  index.json
```

### ✅ Single Trade Ingestion Path
```
js/data/load-trades.js   ← THE ONLY trade loader
```

No duplicate loaders exist (`parseCSV.js`, `guestLoader.js`, etc.)

---

## Usage Examples

### Getting Ship Description for UI
```js
// In UI code (not in data pipeline!)
const dossier = TradeLoader.getShipDossier(tradeData, 'RKLB');
const description = TradeLoader.describeShip(dossier.metrics);
// → { age: 'veteran', damage: 'worn', activity: 'hyperactive', ... }
```

### Getting Looming Expiries for Haunting
```js
const looming = TradeLoader.getLoomingExpiries('RKLB', 30);
// → [{ expiry: '2025-03-21', count: 2, strikes: [15, 20], ... }]
```

### Using Instability for Animation
```js
const { instability } = dossier.metrics;
sprite.style.animationDuration = `${2 - instability}s`;  // More unstable = faster
```

---

## Migration Notes

### Breaking Changes
- `personality` object is now `metrics` object
- Semantic strings removed from data layer
- Call `describeShip()` for UI labels

### Backward Compatibility
Code that reads `dossier.personality.damageScore` should now read:
```js
dossier.metrics.damageScore  // ✓ Normalized scalar
```

Code that displays `dossier.personality.age` should now use:
```js
TradeLoader.describeShip(dossier.metrics).age  // ✓ UI presentation
```

---

## Future Work

- [ ] Inertia-based swipe with resistance
- [ ] Ship index HUD on mobile
- [ ] Option expiry "ghost flashes" on swipe
- [ ] Sin system mapping (OBSESSION→RKLB, RAGE→GME)
