<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SHIP TELEMETRY | SPACE CAPITAL</title>
  <link rel="stylesheet" href="../css/theme.css">
  <!-- UI Overhaul - Pixel discipline, semantic CRT, visual tiers -->
  <link rel="stylesheet" href="../css/ui-overhaul.css">
  <link rel="stylesheet" href="../css/ship-states.css">
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=Orbitron:wght@400;700;900&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --magenta: #FF2975;
      --cyan: #00FFFF;
      --green-neon: #39FF14;
      --yellow: #FFE600;
      --red-alert: #FF0040;
      --bg-void: #0A0A0F;
      --bg-panel: #12121A;
      --bg-surface: #1A1A24;
      --text-primary: #F0F0F0;
      --text-dim: #888899;
      --border-dim: #333344;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      min-height: 100vh;
      background: var(--bg-void);
      font-family: 'VT323', monospace;
      color: var(--text-primary);
    }

    /* Background effects */
    .bg-grid {
      position: fixed;
      inset: 0;
      background-image: 
        linear-gradient(rgba(255, 41, 117, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255, 41, 117, 0.03) 1px, transparent 1px);
      background-size: 50px 50px;
      pointer-events: none;
      z-index: 0;
    }

    .scanlines {
      position: fixed;
      inset: 0;
      background: repeating-linear-gradient(
        0deg, transparent, transparent 2px,
        rgba(0, 0, 0, 0.1) 2px, rgba(0, 0, 0, 0.1) 4px
      );
      pointer-events: none;
      z-index: 1000;
    }

    /* Layout */
    .container {
      position: relative;
      z-index: 1;
      max-width: 1400px;
      margin: 0 auto;
      padding: 1rem;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      background: var(--bg-panel);
      border: 1px solid var(--border-dim);
      margin-bottom: 1rem;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .back-btn {
      padding: 0.5rem 1rem;
      background: transparent;
      border: 1px solid var(--magenta);
      color: var(--magenta);
      font-family: 'VT323', monospace;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .back-btn:hover {
      background: var(--magenta);
      color: #fff;
    }

    .ship-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 1.5rem;
      color: var(--magenta);
      letter-spacing: 0.1em;
    }

    .ship-class {
      font-size: 1rem;
      color: var(--text-dim);
      letter-spacing: 0.2em;
    }

    /* Main Grid */
    .main-grid {
      display: grid;
      grid-template-columns: 300px 1fr 300px;
      gap: 1rem;
      min-height: calc(100vh - 120px);
    }

    @media (max-width: 1200px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Panel Styling */
    .panel {
      background: var(--bg-panel);
      border: 1px solid var(--border-dim);
      padding: 1rem;
    }

    .panel-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 0.9rem;
      color: var(--cyan);
      letter-spacing: 0.1em;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border-dim);
    }

    /* Ship Display */
    .ship-display {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .ship-sprite-container {
      width: 200px;
      height: 200px;
      background: var(--bg-surface);
      border: 2px solid var(--border-dim);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      position: relative;
    }

    .ship-sprite {
      max-width: 160px;
      max-height: 160px;
      image-rendering: pixelated;
    }

    .behavior-badges {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
      justify-content: center;
      margin-bottom: 1rem;
    }

    .behavior-badge {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      letter-spacing: 0.1em;
      border: 1px solid;
    }

    .behavior-badge.thrust { border-color: var(--green-neon); color: var(--green-neon); }
    .behavior-badge.drift { border-color: var(--yellow); color: var(--yellow); }
    .behavior-badge.fail { border-color: var(--red-alert); color: var(--red-alert); }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      gap: 0.75rem;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 0.5rem;
      background: var(--bg-surface);
      border-left: 3px solid var(--border-dim);
    }

    .stat-label {
      color: var(--text-dim);
      font-size: 0.9rem;
    }

    .stat-value {
      font-size: 1.1rem;
      font-weight: bold;
    }

    .stat-value.positive { color: var(--green-neon); }
    .stat-value.negative { color: var(--red-alert); }
    .stat-value.neutral { color: var(--cyan); }

    /* Chart Panel */
    .chart-panel {
      display: flex;
      flex-direction: column;
    }

    .chart-container {
      flex: 1;
      min-height: 400px;
      position: relative;
    }

    .chart-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    .chart-btn {
      padding: 0.4rem 0.8rem;
      background: transparent;
      border: 1px solid var(--border-dim);
      color: var(--text-dim);
      font-family: 'VT323', monospace;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .chart-btn:hover, .chart-btn.active {
      border-color: var(--cyan);
      color: var(--cyan);
    }

    /* Telemetry Panel */
    .telemetry-grid {
      display: grid;
      gap: 0.5rem;
    }

    .telemetry-row {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--bg-surface);
    }

    .telemetry-label {
      font-size: 0.85rem;
      color: var(--text-dim);
    }

    .telemetry-bar {
      width: 100px;
      height: 8px;
      background: var(--bg-void);
      border: 1px solid var(--border-dim);
      position: relative;
    }

    .telemetry-bar-fill {
      height: 100%;
      transition: width 0.3s;
    }

    .telemetry-bar-fill.green { background: var(--green-neon); }
    .telemetry-bar-fill.yellow { background: var(--yellow); }
    .telemetry-bar-fill.red { background: var(--red-alert); }
    .telemetry-bar-fill.cyan { background: var(--cyan); }

    /* Behavior State Grid */
    .behavior-state-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .behavior-state-item {
      background: var(--bg-surface);
      padding: 0.75rem;
      border-left: 3px solid var(--border-dim);
    }

    .behavior-state-label {
      font-size: 0.7rem;
      color: var(--text-dim);
      letter-spacing: 0.1em;
      margin-bottom: 0.25rem;
    }

    .behavior-state-value {
      font-size: 1rem;
      font-weight: bold;
      letter-spacing: 0.05em;
    }

    .behavior-state-value.positive { color: var(--green-neon); border-color: var(--green-neon); }
    .behavior-state-value.negative { color: var(--red-alert); border-color: var(--red-alert); }
    .behavior-state-value.warning { color: var(--yellow); border-color: var(--yellow); }
    .behavior-state-value.neutral { color: var(--cyan); border-color: var(--cyan); }
    .behavior-state-value.extreme { color: var(--magenta); border-color: var(--magenta); }

    .behavior-state-item.positive { border-left-color: var(--green-neon); }
    .behavior-state-item.negative { border-left-color: var(--red-alert); }
    .behavior-state-item.warning { border-left-color: var(--yellow); }
    .behavior-state-item.neutral { border-left-color: var(--cyan); }
    .behavior-state-item.extreme { border-left-color: var(--magenta); }

    .behavior-state-desc {
      font-size: 0.7rem;
      color: var(--text-dim);
      margin-top: 0.25rem;
    }

    /* Position Info */
    .position-section {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-dim);
    }

    .position-title {
      font-size: 0.85rem;
      color: var(--yellow);
      letter-spacing: 0.1em;
      margin-bottom: 0.75rem;
    }

    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 200px;
      color: var(--text-dim);
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border-dim);
      border-top-color: var(--cyan);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 1rem;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* No Data State */
    .no-data {
      text-align: center;
      padding: 2rem;
      color: var(--text-dim);
    }

    .no-data-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>
  <div class="bg-grid"></div>
  <div class="scanlines"></div>

  <div class="container">
    <header class="header">
      <div class="header-left">
        <button class="back-btn" onclick="history.back()">â† BACK</button>
        <div>
          <h1 class="ship-title" id="shipTitle">LOADING...</h1>
          <div class="ship-class" id="shipClass">VESSEL CLASS</div>
        </div>
      </div>
      <div class="header-nav" style="display: flex; gap: 0.5rem;">
        <button class="back-btn" onclick="window.location.href='space-capital.html'">ğŸ“Š FLEET</button>
        <button class="back-btn" onclick="window.location.href='ship-select.html'">ğŸš€ HANGAR</button>
        <button class="back-btn" onclick="window.location.href='derivatives.html'">ğŸ¯ MISSIONS</button>
      </div>
    </header>

    <div class="main-grid">
      <!-- Left: Ship Display & Stats -->
      <div class="panel ship-display">
        <div class="ship-sprite-container">
          <img class="ship-sprite" id="shipSprite" src="" alt="Ship">
        </div>
        
        <div class="behavior-badges" id="behaviorBadges">
          <!-- Populated by JS -->
        </div>

        <div class="stats-grid" id="statsGrid">
          <!-- Populated by JS -->
        </div>

        <div class="position-section" id="positionSection" style="display: none;">
          <div class="position-title">ğŸ“Š POSITION DATA</div>
          <div class="stats-grid" id="positionStats">
            <!-- Populated by JS -->
          </div>
        </div>
      </div>

      <!-- Center: Price Chart -->
      <div class="panel chart-panel">
        <div class="panel-title">PRICE HISTORY</div>
        <div class="chart-controls">
          <button class="chart-btn active" data-range="1M">1M</button>
          <button class="chart-btn" data-range="3M">3M</button>
          <button class="chart-btn" data-range="6M">6M</button>
          <button class="chart-btn" data-range="1Y">1Y</button>
          <button class="chart-btn" data-range="ALL">ALL</button>
        </div>
        <div class="chart-container">
          <canvas id="priceChart"></canvas>
        </div>
      </div>

      <!-- Right: Telemetry & Behavior -->
      <div class="panel">
        <div class="panel-title">BEHAVIOR STATE</div>
        <div class="behavior-state-grid" id="behaviorStateGrid">
          <!-- Populated by JS -->
        </div>
        
        <div class="panel-title" style="margin-top: 1.5rem;">TELEMETRY DATA</div>
        <div class="telemetry-grid" id="telemetryGrid">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- Ship Behavior Engine -->
  <script src="../js/ships/ship-behavior.js"></script>
  <!-- Chart Utilities - Robust data processing -->
  <script src="../js/data/chart-utils.js"></script>
  <!-- Player & Position Managers -->
  <script src="../js/data/player-manager.js"></script>
  <script src="../js/data/position-manager.js"></script>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SHIP TELEMETRY PAGE CONTROLLER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const TICKER_CONFIG = {
      'RKLB': { theme: 'Space', icon: 'ğŸš€', color: '#FF2975', class: 'INTERCEPTOR', sin: 'OBSESSION' },
      'LUNR': { theme: 'Space', icon: 'ğŸŒ™', color: '#9D4EDD', class: 'EXPLORER', sin: 'FAITH' },
      'ASTS': { theme: 'Space', icon: 'ğŸ“¡', color: '#00FFFF', class: 'CRUISER', sin: 'AMBITION' },
      'BKSY': { theme: 'Space', icon: 'ğŸ›°ï¸', color: '#FF69B4', class: 'SCOUT', sin: 'VIGILANCE' },
      'RDW': { theme: 'Space', icon: 'âš™ï¸', color: '#00CCCC', class: 'ENGINEER', sin: 'CRAFT' },
      'PL': { theme: 'Space', icon: 'ğŸŒ', color: '#B8986B', class: 'SURVEYOR', sin: 'WISDOM' },
      'ACHR': { theme: 'Air Mobility', icon: 'ğŸ›¸', color: '#39FF14', class: 'STRIKER', sin: 'VISION' },
      'JOBY': { theme: 'Air Mobility', icon: 'ğŸš', color: '#FFE600', class: 'TRANSPORT', sin: 'PATIENCE' },
      'EVEX': { theme: 'Air Mobility', icon: 'âœˆï¸', color: '#C45C5C', class: 'PROTOTYPE', sin: 'HOPE' },
      'KTOS': { theme: 'Defense', icon: 'ğŸ¯', color: '#FF4444', class: 'FIGHTER', sin: 'PRECISION' },
      'LHX': { theme: 'Defense', icon: 'ğŸ›¡ï¸', color: '#4488FF', class: 'SENTINEL', sin: 'DUTY' },
      'RTX': { theme: 'Defense', icon: 'ğŸ”§', color: '#888888', class: 'CARRIER', sin: 'POWER' },
      'GE': { theme: 'Defense', icon: 'âš¡', color: '#44AAFF', class: 'TITAN', sin: 'LEGACY' },
      'COHR': { theme: 'Tech', icon: 'ğŸ’', color: '#AA44FF', class: 'PHANTOM', sin: 'CLARITY' },
      'GME': { theme: 'Meme', icon: 'ğŸ®', color: '#FF6B35', class: 'BERSERKER', sin: 'RAGE' },
      'XAR': { theme: 'Benchmark', icon: 'ğŸ“Š', color: '#666677', class: 'FLAGSHIP', sin: 'INDEX' },
      'SPY': { theme: 'Benchmark', icon: 'ğŸ“ˆ', color: '#4466AA', class: 'COMMAND', sin: 'MARKET' }
    };

    let currentTicker = null;
    let priceChart = null;
    let telemetryData = null;

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // INITIALIZATION
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function init() {
      // Get ticker from URL
      const params = new URLSearchParams(window.location.search);
      currentTicker = params.get('ship')?.toUpperCase() || params.get('ticker')?.toUpperCase();

      if (!currentTicker || !TICKER_CONFIG[currentTicker]) {
        showNoData();
        return;
      }

      const config = TICKER_CONFIG[currentTicker];
      
      // Update header
      document.getElementById('shipTitle').textContent = `${config.icon} ${currentTicker}`;
      document.getElementById('shipClass').textContent = `${config.class} CLASS // ${config.theme.toUpperCase()}`;
      document.title = `${currentTicker} TELEMETRY | SPACE CAPITAL`;

      // Load ship sprite
      loadShipSprite(currentTicker);

      // Load telemetry data
      await loadTelemetryData(currentTicker);

      // Render everything
      renderStats();
      renderTelemetry();
      renderBehaviorState();
      renderBehaviorBadges();
      renderPositionData();
      initChart();

      // Setup chart controls
      setupChartControls();
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SHIP SPRITE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function loadShipSprite(ticker) {
      const sprite = document.getElementById('shipSprite');
      const gifPath = `../assets/ships/animated/gifs/${ticker}_idle.gif`;
      const staticPath = `../assets/ships/static/${ticker}-*.png`;
      
      sprite.src = gifPath;
      sprite.onerror = () => {
        // Fallback to static if GIF not found
        sprite.src = `../assets/ships/static/${ticker.toLowerCase()}.png`;
        sprite.onerror = () => {
          sprite.src = '../assets/ships/static/Unclaimed-Drone-ship.png';
        };
      };
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // TELEMETRY DATA
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function loadTelemetryData(ticker) {
      try {
        // Try to load from fleet.json
        const fleetRes = await fetch('../data/telemetry/fleet.json');
        if (fleetRes.ok) {
          const fleetData = await fleetRes.json();
          const position = fleetData.positions?.find(p => p.ticker === ticker);
          if (position) {
            telemetryData = position;
            return;
          }
        }

        // Try to load individual timeseries
        const tsRes = await fetch(`../data/timeseries/${ticker.toLowerCase()}.json`);
        if (tsRes.ok) {
          telemetryData = await tsRes.json();
          return;
        }

        // Generate mock data if nothing found
        telemetryData = generateMockTelemetry(ticker);
      } catch (e) {
        console.warn('[Telemetry] Failed to load data:', e);
        telemetryData = generateMockTelemetry(ticker);
      }
    }

    function generateMockTelemetry(ticker) {
      const config = TICKER_CONFIG[ticker];
      return {
        ticker,
        current_price: 25 + Math.random() * 50,
        chgPct: (Math.random() - 0.5) * 10,
        volatility: 0.3 + Math.random() * 0.5,
        trend: (Math.random() - 0.5) * 2,
        momentum: (Math.random() - 0.5) * 2,
        activity: 0.3 + Math.random() * 0.7,
        signalState: ['bull', 'bear', 'neutral'][Math.floor(Math.random() * 3)],
        visual: {
          glow: 0.3 + Math.random() * 0.5,
          thrust: 0.2 + Math.random() * 0.6,
          damage: Math.random() * 0.3
        }
      };
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // RENDER STATS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderStats() {
      const grid = document.getElementById('statsGrid');
      const config = TICKER_CONFIG[currentTicker];
      
      const price = telemetryData.current_price || telemetryData.stock_price || 0;
      const change = telemetryData.chgPct || 0;
      const changeClass = change >= 0 ? 'positive' : 'negative';
      const changeStr = change >= 0 ? `+${change.toFixed(2)}%` : `${change.toFixed(2)}%`;

      grid.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">PRICE</span>
          <span class="stat-value neutral">$${price.toFixed(2)}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">CHANGE</span>
          <span class="stat-value ${changeClass}">${changeStr}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">SECTOR</span>
          <span class="stat-value neutral">${config.theme}</span>
        </div>
        <div class="stat-row">
          <span class="stat-label">SIN</span>
          <span class="stat-value" style="color: ${config.color}">${config.sin}</span>
        </div>
      `;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // RENDER TELEMETRY BARS
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderTelemetry() {
      const grid = document.getElementById('telemetryGrid');
      
      const metrics = [
        { label: 'VOLATILITY', value: telemetryData.volatility || 0.5, color: 'yellow' },
        { label: 'MOMENTUM', value: (telemetryData.momentum + 1) / 2 || 0.5, color: telemetryData.momentum > 0 ? 'green' : 'red' },
        { label: 'TREND', value: (telemetryData.trend + 1) / 2 || 0.5, color: telemetryData.trend > 0 ? 'green' : 'red' },
        { label: 'ACTIVITY', value: telemetryData.activity || 0.5, color: 'cyan' },
        { label: 'THRUST', value: telemetryData.visual?.thrust || 0.5, color: 'green' },
        { label: 'DAMAGE', value: telemetryData.visual?.damage || 0, color: 'red' },
        { label: 'GLOW', value: telemetryData.visual?.glow || 0.5, color: 'cyan' }
      ];

      grid.innerHTML = metrics.map(m => `
        <div class="telemetry-row">
          <span class="telemetry-label">${m.label}</span>
          <div class="telemetry-bar">
            <div class="telemetry-bar-fill ${m.color}" style="width: ${Math.min(100, m.value * 100)}%"></div>
          </div>
        </div>
      `).join('');
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // RENDER BEHAVIOR STATE - Clear breakdown of ship's current state
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderBehaviorState() {
      const grid = document.getElementById('behaviorStateGrid');
      const change = telemetryData.chgPct || 0;
      const volatility = telemetryData.volatility || 0.5;
      const damage = telemetryData.visual?.damage || 0;
      const hull = Math.max(0, 100 - damage * 100);
      const activity = telemetryData.activity || 0.5;
      const fuel = activity * 100;

      // Determine thrust state
      let thrustState, thrustClass, thrustDesc;
      if (change >= 5) {
        thrustState = 'Strong Positive';
        thrustClass = 'positive';
        thrustDesc = 'Full thrust forward, intense engine glow';
      } else if (change >= 0) {
        thrustState = 'Positive';
        thrustClass = 'positive';
        thrustDesc = 'Gentle thrust, moderate glow';
      } else if (change >= -5) {
        thrustState = 'Negative';
        thrustClass = 'warning';
        thrustDesc = 'Backward drift, dimmer engines';
      } else {
        thrustState = 'Failing';
        thrustClass = 'negative';
        thrustDesc = 'Flickering, heavy backward drift';
      }

      // Determine stability state
      let stabilityState, stabilityClass, stabilityDesc;
      if (volatility < 0.03) {
        stabilityState = 'Stable';
        stabilityClass = 'neutral';
        stabilityDesc = 'No volatility effects';
      } else if (volatility < 0.05) {
        stabilityState = 'Elevated';
        stabilityClass = 'warning';
        stabilityDesc = 'Subtle vibration';
      } else if (volatility < 0.08) {
        stabilityState = 'High';
        stabilityClass = 'warning';
        stabilityDesc = 'Noticeable shake';
      } else {
        stabilityState = 'Extreme';
        stabilityClass = 'extreme';
        stabilityDesc = 'Violent shaking';
      }

      // Determine hull state
      let hullState, hullClass, hullDesc;
      if (hull >= 80) {
        hullState = 'Optimal';
        hullClass = 'positive';
        hullDesc = 'Clean, no effects';
      } else if (hull >= 50) {
        hullState = 'Stressed';
        hullClass = 'warning';
        hullDesc = 'Warning amber tint';
      } else if (hull >= 25) {
        hullState = 'Critical';
        hullClass = 'negative';
        hullDesc = 'Red tint, damage pulse';
      } else {
        hullState = 'Failing';
        hullClass = 'negative';
        hullDesc = 'Flashing, critical state';
      }

      // Determine mood based on combined factors
      let moodState, moodClass, moodDesc;
      const moodScore = (change > 0 ? 1 : 0) + (volatility < 0.05 ? 1 : 0) + (hull > 50 ? 1 : 0);
      if (moodScore >= 3) {
        moodState = 'Confident';
        moodClass = 'positive';
        moodDesc = 'Aggressive forward stance';
      } else if (moodScore >= 2) {
        moodState = 'Alert';
        moodClass = 'neutral';
        moodDesc = 'Scanning, ready state';
      } else if (moodScore >= 1) {
        moodState = 'Cautious';
        moodClass = 'warning';
        moodDesc = 'Defensive positioning';
      } else {
        moodState = 'Distressed';
        moodClass = 'negative';
        moodDesc = 'Erratic movement';
      }

      grid.innerHTML = `
        <div class="behavior-state-item ${thrustClass}">
          <div class="behavior-state-label">THRUST</div>
          <div class="behavior-state-value ${thrustClass}">${thrustState}</div>
          <div class="behavior-state-desc">${thrustDesc}</div>
        </div>
        <div class="behavior-state-item ${stabilityClass}">
          <div class="behavior-state-label">STABILITY</div>
          <div class="behavior-state-value ${stabilityClass}">${stabilityState}</div>
          <div class="behavior-state-desc">${stabilityDesc}</div>
        </div>
        <div class="behavior-state-item ${hullClass}">
          <div class="behavior-state-label">HULL</div>
          <div class="behavior-state-value ${hullClass}">${hullState}</div>
          <div class="behavior-state-desc">${hullDesc}</div>
        </div>
        <div class="behavior-state-item ${moodClass}">
          <div class="behavior-state-label">MOOD</div>
          <div class="behavior-state-value ${moodClass}">${moodState}</div>
          <div class="behavior-state-desc">${moodDesc}</div>
        </div>
      `;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // RENDER BEHAVIOR BADGES
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderBehaviorBadges() {
      const container = document.getElementById('behaviorBadges');
      const change = telemetryData.chgPct || 0;
      const volatility = telemetryData.volatility || 0.5;
      const damage = telemetryData.visual?.damage || 0;

      let thrustState = 'DRIFT';
      let thrustClass = 'drift';
      if (change >= 5) { thrustState = 'THRUST++'; thrustClass = 'thrust'; }
      else if (change >= 0) { thrustState = 'THRUST+'; thrustClass = 'thrust'; }
      else if (change <= -5) { thrustState = 'FAIL'; thrustClass = 'fail'; }

      const hullPct = Math.max(0, 100 - damage * 100);
      const hullClass = hullPct > 50 ? 'thrust' : hullPct > 25 ? 'drift' : 'fail';

      container.innerHTML = `
        <span class="behavior-badge ${thrustClass}">${thrustState}</span>
        <span class="behavior-badge ${volatility > 0.6 ? 'drift' : 'thrust'}">VOL: ${(volatility * 100).toFixed(0)}%</span>
        <span class="behavior-badge ${hullClass}">HULL: ${hullPct.toFixed(0)}%</span>
      `;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // RENDER POSITION DATA
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function renderPositionData() {
      if (!window.PositionManager) return;

      const position = PositionManager.get(currentTicker);
      if (!position) return;

      const section = document.getElementById('positionSection');
      const grid = document.getElementById('positionStats');
      section.style.display = 'block';

      const totalPL = position.totalPL || 0;
      const plClass = totalPL >= 0 ? 'positive' : 'negative';
      const plStr = totalPL >= 0 ? `+$${totalPL.toFixed(2)}` : `-$${Math.abs(totalPL).toFixed(2)}`;

      grid.innerHTML = `
        <div class="stat-row">
          <span class="stat-label">TOTAL P&L</span>
          <span class="stat-value ${plClass}">${plStr}</span>
        </div>
        ${position.stockPL ? `
        <div class="stat-row">
          <span class="stat-label">STOCK P&L</span>
          <span class="stat-value ${position.stockPL >= 0 ? 'positive' : 'negative'}">$${position.stockPL.toFixed(2)}</span>
        </div>` : ''}
        ${position.optionsPL ? `
        <div class="stat-row">
          <span class="stat-label">OPTIONS P&L</span>
          <span class="stat-value ${position.optionsPL >= 0 ? 'positive' : 'negative'}">$${position.optionsPL.toFixed(2)}</span>
        </div>` : ''}
      `;
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // PRICE CHART - Using ChartUtils for robust rendering
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    async function initChart() {
      const ctx = document.getElementById('priceChart').getContext('2d');
      const config = TICKER_CONFIG[currentTicker];

      // Load and process chart data using ChartUtils
      let rawData = await loadRawChartData('1M');
      
      // Diagnose data for issues (dev debugging)
      if (window.ChartUtils) {
        const diagnosis = ChartUtils.diagnoseData(rawData);
        if (!diagnosis.valid) {
          console.warn('[Chart] Data issues detected:', diagnosis.issues);
        }
      }

      // Prepare data with deduplication, sorting, and downsampling
      const chartData = window.ChartUtils 
        ? ChartUtils.prepareChartData(rawData, { targetPoints: 150 })
        : fallbackPrepareData(rawData);

      // Create chart with optimal config
      const chartConfig = window.ChartUtils
        ? ChartUtils.createChartConfig(chartData, { color: config.color, label: currentTicker })
        : createFallbackConfig(chartData, config);

      priceChart = new Chart(ctx, chartConfig);
    }

    async function loadRawChartData(range) {
      // Try to load from timeseries
      try {
        const res = await fetch(`../data/timeseries/${currentTicker.toLowerCase()}.json`);
        if (res.ok) {
          const data = await res.json();
          // Filter by range
          const now = new Date();
          const ranges = {
            '1M': 30, '3M': 90, '6M': 180, '1Y': 365, 'ALL': 9999
          };
          const days = ranges[range] || 30;
          const cutoff = new Date(now - days * 24 * 60 * 60 * 1000);
          
          // Return raw data with consistent format
          const rawArray = data.prices || data;
          return rawArray
            .filter(p => new Date(p.date) >= cutoff)
            .map(p => ({
              date: p.date,
              close: p.close || p.price,
              time: new Date(p.date).getTime()
            }));
        }
      } catch (e) {
        console.warn('[Chart] Failed to load timeseries:', e);
      }

      // Generate mock data
      return generateMockChartData(range);
    }

    // Fallback data preparation if ChartUtils not loaded
    function fallbackPrepareData(rawData) {
      const seen = new Set();
      const cleaned = rawData.filter(d => {
        if (seen.has(d.date)) return false;
        seen.add(d.date);
        return true;
      });
      
      cleaned.sort((a, b) => new Date(a.date) - new Date(b.date));
      
      return {
        labels: cleaned.map(p => new Date(p.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
        prices: cleaned.map(p => p.close),
        domain: {
          min: Math.min(...cleaned.map(p => p.close)) * 0.95,
          max: Math.max(...cleaned.map(p => p.close)) * 1.05
        }
      };
    }

    // Fallback chart config
    function createFallbackConfig(chartData, config) {
      return {
        type: 'line',
        data: {
          labels: chartData.labels,
          datasets: [{
            label: currentTicker,
            data: chartData.prices,
            borderColor: config.color,
            backgroundColor: config.color + '20',
            fill: true,
            tension: 0.1,
            pointRadius: 0,
            borderWidth: 2,
            spanGaps: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#12121A',
              borderColor: config.color,
              borderWidth: 1,
              titleFont: { family: 'VT323' },
              bodyFont: { family: 'VT323' }
            }
          },
          scales: {
            x: {
              grid: { color: '#333344' },
              ticks: { color: '#888899', font: { family: 'VT323' } }
            },
            y: {
              min: chartData.domain.min,
              max: chartData.domain.max,
              grid: { color: '#333344' },
              ticks: { 
                color: '#888899', 
                font: { family: 'VT323' },
                callback: (value) => '$' + value.toFixed(2)
              }
            }
          }
        }
      };
    }

    function generateMockChartData(range) {
      const days = { '1M': 30, '3M': 90, '6M': 180, '1Y': 365, 'ALL': 500 }[range] || 30;
      const basePrice = telemetryData.current_price || 30;
      const data = [];

      for (let i = days; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        
        // Random walk with drift
        const noise = (Math.random() - 0.5) * basePrice * 0.05;
        const trend = (days - i) / days * basePrice * 0.1 * (Math.random() > 0.5 ? 1 : -1);
        
        data.push({
          date: date.toISOString().split('T')[0],
          close: Math.max(1, basePrice + noise + trend),
          time: date.getTime()
        });
      }

      return data;
    }

    function setupChartControls() {
      document.querySelectorAll('.chart-btn').forEach(btn => {
        btn.addEventListener('click', async () => {
          document.querySelectorAll('.chart-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          const range = btn.dataset.range;
          const rawData = await loadRawChartData(range);
          
          // Process with ChartUtils
          const chartData = window.ChartUtils 
            ? ChartUtils.prepareChartData(rawData, { targetPoints: 150 })
            : fallbackPrepareData(rawData);
          
          // Update chart
          priceChart.data.labels = chartData.labels.map(l => 
            window.ChartUtils ? ChartUtils.formatDate(l) : l
          );
          priceChart.data.datasets[0].data = chartData.prices;
          priceChart.options.scales.y.min = chartData.domain.min;
          priceChart.options.scales.y.max = chartData.domain.max;
          priceChart.update();
        });
      });
    }

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // NO DATA STATE
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

    function showNoData() {
      document.querySelector('.main-grid').innerHTML = `
        <div class="panel no-data" style="grid-column: 1 / -1;">
          <div class="no-data-icon">ğŸš€</div>
          <h2>SHIP NOT FOUND</h2>
          <p>No telemetry data available for this vessel.</p>
          <button class="back-btn" onclick="history.back()" style="margin-top: 1rem;">â† RETURN TO HANGAR</button>
        </div>
      `;
    }

    // Start
    init();
  </script>
</body>
</html>
