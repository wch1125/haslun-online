<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SPACE CAPITAL // FLEET COMMAND</title>
  <!-- SVG favicon - no emoji -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'><rect width='64' height='64' fill='%230A0A0F'/><text x='8' y='44' font-size='32' font-family='monospace' font-weight='bold' fill='%23FF2975'>SC</text></svg>">
  <link href="https://fonts.googleapis.com/css2?family=VT323&family=IBM+Plex+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <!-- Shared theme variables (cache-bust) -->
  <link rel="stylesheet" href="../css/theme.css?v=20260108">
  <!-- Canonical CRT App Shell (ONE consistent overlay for all pages) -->
  <link rel="stylesheet" href="../css/crt-shell.css?v=20260108">
  <!-- UI Overhaul - Pixel discipline, semantic CRT, visual tiers -->
  <link rel="stylesheet" href="../css/ui-overhaul.css?v=20260108">
  <!-- Ship behavior states (thrust, volatility, hull effects) -->
  <link rel="stylesheet" href="../css/ship-states.css?v=20260108">
  <!-- Module viewer overlay -->
  <link rel="stylesheet" href="../css/module-viewer.css?v=20260108">
  <!-- Fleet command styles (position chips, fleet HUD) -->
  <link rel="stylesheet" href="../css/fleet-command.css?v=20260108">
  <style>
    /* =========================================================================
       HOTLINE MIAMI AESTHETIC - SPACE CAPITAL
       "VHS murder terminal pretending to be a dashboard"
       ========================================================================= */
    :root {
      /* === LOCKED HOTLINE MIAMI PALETTE === */
      /* Only THREE pigments - everything else is derived */
      --hm-magenta: rgb(255, 41, 117);
      --hm-cyan: rgb(0, 255, 255);
      --hm-yellow: rgb(255, 230, 0);
      
      /* UI semantic mapping - INTENTIONALLY COLLAPSED */
      --ui-primary: var(--hm-magenta);
      --ui-secondary: var(--hm-cyan);
      --ui-warning: var(--hm-yellow);
      
      /* Legacy aliases (for compatibility) */
      --magenta: var(--hm-magenta);
      --magenta-dark: #CC1F5C;
      --magenta-glow: #FF69B4;
      --magenta-ghost: rgba(255, 41, 117, 0.3);
      --cyan: var(--hm-cyan);
      --cyan-dark: #00CCCC;
      --yellow: var(--hm-yellow);
      --yellow-dim: rgba(255, 230, 0, 0.6);
      --orange: #FF6B35;
      --orange-dim: rgba(255, 107, 53, 0.6);
      --purple: #9D4EDD;
      /* REMOVED: green-neon, red-alert - use magenta/cyan instead */
      --green-neon: var(--hm-cyan); /* Collapsed to cyan */
      --red-alert: var(--hm-magenta); /* Collapsed to magenta */
      
      /* Backgrounds - warm magenta-tinted blacks */
      --bg-void: #0A0A0F;
      --bg-panel: #12121A;
      --bg-surface: #1A1A24;
      --bg-elevated: #22222E;
      
      /* Text */
      --text-primary: #F0F0F0;
      --text-dim: #888899;
      --text-muted: #555566;
      
      /* Borders - always magenta-derived */
      --border-harsh: var(--hm-magenta);
      --border-dim: #333344;
      --border-panel: #2A2A3A;
      
      /* Typography */
      --font-main: 'VT323', monospace;
      --font-display: 'VT323', monospace;
      
      /* VHS/CRT Effects */
      --scanline-opacity: 0.04;
      --noise-opacity: 0.03;
      --glow-spread: 20px;
      --vhs-blur: 0.5px;
      --artifact-persistence: 0.15;
    }

    /* Reset & Base */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; min-height: 100vh; overflow-x: hidden; }
    
    body {
      /* Miami chromatic black - NOT green-neutral */
      /* This gives watercolor pigments chromatic headroom to react */
      background: var(--bg-miami-gradient, linear-gradient(180deg, #14000b 0%, #0a0011 45%, #050008 100%));
      color: var(--text-primary);
      font-family: var(--font-main);
      font-size: 16px;
      line-height: 1.4;
      position: relative;
    }
    
    /* Parallax layers - atmospheric depth (Miami chromatic) */
    .parallax-layer {
      position: fixed;
      inset: -10px; /* Slight overflow to prevent edge gaps during movement */
      pointer-events: none;
      z-index: 0;
    }
    
    .layer-bg {
      background: radial-gradient(
        ellipse at center,
        rgba(20, 0, 11, 0.3) 0%,
        rgba(5, 0, 8, 0.8) 70%
      );
    }
    
    /* Watercolor wash layer - sits above base, below CRT */
    .watercolor-layer {
      z-index: 1;
      opacity: 0.85;
    }
    
    /* Ensure content is above parallax layers */
    .app {
      position: relative;
      z-index: 5;
    }

    /* =========================================================================
       VHS / CRT OVERLAY EFFECTS
       ========================================================================= */
    
    /* Scanlines */
    .scanlines {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9999;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 0, 0, var(--scanline-opacity)) 2px,
        rgba(0, 0, 0, var(--scanline-opacity)) 4px
      );
    }

    /* VHS Noise */
    .vhs-noise {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9998;
      opacity: var(--noise-opacity);
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      animation: noise-shift 0.5s steps(10) infinite;
    }

    @keyframes noise-shift {
      0%, 100% { transform: translate(0, 0); }
      10% { transform: translate(-1%, -1%); }
      20% { transform: translate(1%, 1%); }
      30% { transform: translate(-1%, 1%); }
      40% { transform: translate(1%, -1%); }
      50% { transform: translate(-1%, 0); }
      60% { transform: translate(1%, 0); }
      70% { transform: translate(0, -1%); }
      80% { transform: translate(0, 1%); }
      90% { transform: translate(-1%, -1%); }
    }

    /* =========================================================================
       PALETTE COLLAPSE - Hotline Miami uses REPETITION not variety
       "If something looks boring, that's good"
       ========================================================================= */
    
    /* All buttons default to primary (magenta) */
    button,
    .btn,
    [role="button"] {
      color: var(--ui-primary);
      border-color: var(--ui-primary);
    }
    
    /* All data/graphs default to secondary (cyan) */
    .graph-line,
    .metric-highlight,
    .telemetry-value,
    .stat-value.neutral,
    .data-readout {
      color: var(--ui-secondary);
    }
    
    /* All warnings/volatility to yellow */
    .warning,
    .volatility,
    .caution {
      color: var(--ui-warning);
    }
    
    /* Graph secondary lines always cyan */
    .graph-secondary,
    .signal-line {
      color: var(--ui-secondary);
    }

    /* Chromatic Aberration on hover */
    .chromatic-target {
      position: relative;
    }
    .chromatic-target::before,
    .chromatic-target::after {
      content: attr(data-text);
      position: absolute;
      inset: 0;
      opacity: 0;
      transition: opacity 0.1s;
    }
    .chromatic-target:hover::before {
      color: var(--cyan);
      left: -2px;
      opacity: 0.7;
      clip-path: inset(0 0 50% 0);
    }
    .chromatic-target:hover::after {
      color: var(--magenta);
      left: 2px;
      opacity: 0.7;
      clip-path: inset(50% 0 0 0);
    }

    /* CRT Vignette */
    .crt-vignette {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9997;
      background: radial-gradient(
        ellipse at center,
        transparent 0%,
        transparent 60%,
        rgba(0, 0, 0, 0.4) 100%
      );
    }

    /* =========================================================================
       LAYOUT
       ========================================================================= */
    .app {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: var(--bg-panel);
      border-bottom: 3px solid var(--magenta);
      position: relative;
    }

    .header::after {
      content: '';
      position: absolute;
      bottom: -3px;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--magenta);
      box-shadow: 0 0 20px var(--magenta), 0 0 40px var(--magenta-dark);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .header-logo {
      font-size: 2rem;
      filter: drop-shadow(0 0 10px var(--magenta));
      animation: logo-pulse 2s ease-in-out infinite;
    }

    @keyframes logo-pulse {
      0%, 100% { filter: drop-shadow(0 0 10px var(--magenta)); }
      50% { filter: drop-shadow(0 0 20px var(--magenta)) drop-shadow(0 0 30px var(--cyan)); }
    }

    .header-title {
      font-size: 1.75rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--magenta);
      text-shadow: 0 0 10px var(--magenta), 0 0 20px var(--magenta-dark);
      margin: 0;
    }

    .header-subtitle {
      font-size: 0.875rem;
      letter-spacing: 0.3em;
      color: var(--text-dim);
      text-transform: uppercase;
    }

    .header-status {
      display: flex;
      align-items: center;
      gap: 2rem;
    }

    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.875rem;
      text-transform: uppercase;
      letter-spacing: 0.1em;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: var(--text-muted);
      box-shadow: 0 0 10px currentColor;
    }

    .status-dot.online {
      background: var(--green-neon);
      box-shadow: 0 0 10px var(--green-neon), 0 0 20px var(--green-neon);
      animation: pulse-glow 1s ease-in-out infinite;
    }

    .status-dot.warning {
      background: var(--yellow);
      box-shadow: 0 0 10px var(--yellow);
    }

    /* Pilot Button */
    .pilot-btn {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.75rem !important;
      border: 1px solid var(--cyan) !important;
      background: rgba(0, 255, 255, 0.1) !important;
    }

    .pilot-btn:hover {
      background: rgba(0, 255, 255, 0.2) !important;
      box-shadow: 0 0 15px rgba(0, 255, 255, 0.3);
    }

    .pilot-avatar-mini {
      width: 24px;
      height: 24px;
      border-radius: 2px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #111;
    }

    .pilot-avatar-mini img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      image-rendering: pixelated;
    }

    .status-dot.offline {
      background: var(--red-alert);
      box-shadow: 0 0 10px var(--red-alert);
    }

    @keyframes pulse-glow {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }

    /* Main Content */
    .main-content {
      flex: 1;
      padding: 1.5rem;
      display: grid;
      grid-template-columns: 1fr 320px;
      gap: 1.5rem;
    }

    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }

    /* =========================================================================
       PANELS - COCKPIT STYLE
       ========================================================================= */
    .panel {
      background: var(--bg-panel);
      border: 2px solid var(--border-panel);
      position: relative;
    }

    /* Corner brackets */
    .panel::before,
    .panel::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-color: var(--magenta);
      border-style: solid;
    }

    .panel::before {
      top: -2px;
      left: -2px;
      border-width: 3px 0 0 3px;
    }

    .panel::after {
      top: -2px;
      right: -2px;
      border-width: 3px 3px 0 0;
    }

    .panel-corners::before,
    .panel-corners::after {
      content: '';
      position: absolute;
      width: 20px;
      height: 20px;
      border-color: var(--magenta);
      border-style: solid;
    }

    .panel-corners::before {
      bottom: -2px;
      left: -2px;
      border-width: 0 0 3px 3px;
    }

    .panel-corners::after {
      bottom: -2px;
      right: -2px;
      border-width: 0 3px 3px 0;
    }

    .panel-header {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-dim);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .panel-label {
      font-size: 0.625rem;
      letter-spacing: 0.2em;
      color: var(--cyan);
      text-transform: uppercase;
      opacity: 0.8;
    }

    .panel-title {
      font-size: 1.125rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-primary);
      margin: 0.25rem 0 0;
    }

    .panel-body {
      padding: 1rem;
    }

    /* =========================================================================
       FLEET HANGAR - SHIP VISUALIZATIONS
       ========================================================================= */
    .fleet-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
    }

    /* ═══════════════════════════════════════════════════════════════════════
       SHIP CARDS - Hotline Miami Aesthetic
       "VHS murder terminal" - scarred, not polished
       ═══════════════════════════════════════════════════════════════════════ */
    .ship-card {
      background: var(--bg-surface);
      border: 2px solid var(--ui-primary);
      padding: 1rem;
      position: relative;
      transition: all 0.2s ease;
      cursor: pointer;
      /* Corner cut aesthetic */
      clip-path: polygon(0 8px, 8px 0, 100% 0, 100% calc(100% - 8px), calc(100% - 8px) 100%, 0 100%);
    }

    /* Magenta gradient wash */
    .ship-card::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255, 41, 117, 0.08) 0%, transparent 50%);
      pointer-events: none;
      z-index: 1;
    }

    /* CRT DAMAGE OVERLAY - kills "dashboard polish", adds menace */
    .ship-card::after {
      content: '';
      position: absolute;
      inset: 0;
      background:
        repeating-linear-gradient(
          0deg,
          rgba(255, 255, 255, 0.015),
          rgba(255, 255, 255, 0.015) 1px,
          transparent 1px,
          transparent 3px
        ),
        repeating-linear-gradient(
          90deg,
          rgba(255, 41, 117, 0.01),
          rgba(255, 41, 117, 0.01) 1px,
          transparent 1px,
          transparent 4px
        );
      pointer-events: none;
      mix-blend-mode: overlay;
      z-index: 10;
    }

    .ship-card:hover {
      border-color: var(--ui-primary);
      box-shadow: 
        0 0 25px rgba(255, 41, 117, 0.4), 
        0 0 50px rgba(255, 41, 117, 0.15), 
        inset 0 0 30px rgba(255, 41, 117, 0.08);
    }

    /* P&L classes only affect text color, NOT borders */
    .ship-card.positive,
    .ship-card.negative {
      border-color: var(--ui-primary);
    }

    .ship-card.positive:hover,
    .ship-card.negative:hover {
      box-shadow: 
        0 0 25px rgba(255, 41, 117, 0.4), 
        0 0 50px rgba(255, 41, 117, 0.15), 
        inset 0 0 30px rgba(255, 41, 117, 0.08);
    }

    /* Focused state - when navigating from another page with ?ticker= */
    .ship-card.focused {
      outline: 3px solid var(--cyan);
      box-shadow: 0 0 30px rgba(0, 255, 255, 0.5), inset 0 0 20px rgba(0, 255, 255, 0.1);
      animation: focusPulse 1.2s ease-in-out infinite;
    }

    @keyframes focusPulse {
      0%, 100% { transform: translateY(0); box-shadow: 0 0 30px rgba(0, 255, 255, 0.5); }
      50% { transform: translateY(-4px); box-shadow: 0 0 50px rgba(0, 255, 255, 0.8); }
    }

    /* Ship Header - Miami Typography */
    .ship-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
    }

    .ship-callsign {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .ship-ticker {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 0.1em;
      color: var(--magenta);
      text-shadow: 0 0 10px var(--magenta);
    }

    .ship-class {
      font-family: var(--font-display);
      font-size: 0.75rem;
      letter-spacing: 0.15em;
      color: var(--text-dim);
      text-transform: uppercase;
      padding: 0.25rem 0.5rem;
      border: 1px solid var(--magenta-ghost);
      background: var(--bg-panel);
    }

    .ship-pnl {
      font-family: var(--font-display);
      font-size: 1.125rem;
      font-weight: bold;
      letter-spacing: 0.05em;
    }

    /* P&L text colors (borders stay magenta) */
    .ship-pnl.positive {
      color: var(--cyan);
      text-shadow: 0 0 10px var(--cyan);
    }

    .ship-pnl.negative {
      color: var(--magenta);
      text-shadow: 0 0 10px var(--magenta);
    }

    /* Ship Visualization - With MACD as backdrop */
    .ship-display {
      height: 120px;
      margin: 0.75rem 0;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-void);
      border: 1px solid var(--magenta-ghost);
      overflow: hidden;
    }

    /* Grid overlay on ship display */
    .ship-display::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        linear-gradient(90deg, transparent 49%, rgba(255, 41, 117, 0.1) 49%, rgba(255, 41, 117, 0.1) 51%, transparent 51%),
        linear-gradient(0deg, transparent 49%, rgba(255, 41, 117, 0.1) 49%, rgba(255, 41, 117, 0.1) 51%, transparent 51%);
      background-size: 20px 20px;
      pointer-events: none;
      z-index: 1;
    }

    /* MACD backdrop layer - sits behind ship */
    .macd-backdrop {
      position: absolute;
      inset: 0;
      z-index: 0;
      opacity: 0.6;
      pointer-events: none;
    }

    .macd-backdrop canvas {
      width: 100%;
      height: 100%;
    }

    .macd-backdrop .macd-zero-line {
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 1px;
      background: rgba(255, 41, 117, 0.3);
    }

    /* Ship Sprite - Pixel Art Style */
    .ship-sprite {
      width: 64px;
      height: 64px;
      position: relative;
      image-rendering: pixelated;
      filter: drop-shadow(0 0 10px var(--magenta));
      transition: transform 0.3s ease, filter 0.3s ease;
    }

    .ship-card:hover .ship-sprite {
      transform: scale(1.1);
    }

    .ship-sprite svg {
      width: 100%;
      height: 100%;
      position: relative;
      z-index: 1;
    }

    .ship-sprite .damage-overlay {
      position: absolute;
      inset: 0;
      z-index: 2;
    }

    /* Engine glow based on delta */
    .engine-glow {
      position: absolute;
      bottom: -10px;
      left: 50%;
      transform: translateX(-50%);
      width: 20px;
      height: 30px;
      background: linear-gradient(to bottom, var(--cyan), transparent);
      opacity: 0.8;
      filter: blur(5px);
      animation: engine-flicker 0.15s ease-in-out infinite alternate;
    }

    @keyframes engine-flicker {
      0% { opacity: 0.6; transform: translateX(-50%) scaleY(0.9); }
      100% { opacity: 1; transform: translateX(-50%) scaleY(1.1); }
    }

    /* Signal state indicator */
    .signal-indicator {
      position: absolute;
      top: 8px;
      right: 8px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      animation: signal-pulse 1.5s ease-in-out infinite;
    }

    @keyframes signal-pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(0.8); }
    }

    /* Damage overlay for struggling positions */
    .damage-overlay {
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(255, 0, 64, 0.3) 2px,
        rgba(255, 0, 64, 0.3) 4px
      );
      pointer-events: none;
      animation: damage-flicker 0.5s steps(2) infinite;
    }

    @keyframes damage-flicker {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* High volatility jitter animation */
    .ship-card.high-volatility .ship-sprite {
      animation: volatility-jitter 0.1s steps(2) infinite;
    }

    @keyframes volatility-jitter {
      0% { transform: translate(0, 0); }
      25% { transform: translate(-1px, 1px); }
      50% { transform: translate(1px, -1px); }
      75% { transform: translate(-1px, -1px); }
      100% { transform: translate(1px, 1px); }
    }

    /* ═══════════════════════════════════════════════════════════════════════
       ANIMATED SHIP SPRITES
       GIF-based animations driven by telemetry data
       ═══════════════════════════════════════════════════════════════════════ */
    
    .ship-sprite-wrap {
      position: relative;
      width: 80px;
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Hotline Miami glow */
      filter: drop-shadow(0 0 8px var(--ship-color, var(--magenta)));
      transition: filter 0.3s ease, transform 0.2s ease;
    }
    
    .ship-sprite-wrap:hover {
      transform: scale(1.08);
      filter: drop-shadow(0 0 15px var(--ship-color, var(--magenta))) 
              drop-shadow(0 0 25px var(--ship-color, var(--magenta)));
    }
    
    .ship-sprite-img {
      width: 80px;
      height: 80px;
      object-fit: contain;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
      /* GPU acceleration for smooth GIF playback */
      transform: translateZ(0);
      will-change: transform;
    }
    
    /* ───────────────────────────────────────────────────────────────────────
       TELEMETRY-DRIVEN EFFECTS
       Classes added by ShipAnimator based on market data
       ─────────────────────────────────────────────────────────────────────── */
    
    /* High Volatility - Jitter/shake effect */
    .ship-sprite-wrap.ship--volatile {
      animation: sprite-jitter 0.12s steps(3) infinite;
    }
    
    @keyframes sprite-jitter {
      0%, 100% { transform: translate(0, 0); }
      25% { transform: translate(-2px, 1px); }
      50% { transform: translate(2px, -1px); }
      75% { transform: translate(-1px, -2px); }
    }
    
    /* Damaged / Bearish - Red damage overlay with scanlines */
    .ship-sprite-wrap.ship--damaged::after {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 3px,
          rgba(255, 0, 64, 0.15) 3px,
          rgba(255, 0, 64, 0.15) 4px
        );
      pointer-events: none;
      animation: damage-pulse 0.4s steps(2) infinite;
    }
    
    @keyframes damage-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* High Thrust/Momentum - Enhanced glow */
    .ship-sprite-wrap.ship--thrust {
      filter: drop-shadow(0 0 12px var(--ship-color, var(--cyan))) 
              drop-shadow(0 0 25px var(--ship-color, var(--cyan)))
              drop-shadow(0 4px 20px var(--cyan));
    }
    
    /* Bull Signal - Green tint glow */
    .ship-sprite-wrap.ship--bull {
      filter: drop-shadow(0 0 10px var(--green-neon)) 
              drop-shadow(0 0 20px rgba(57, 255, 20, 0.4));
    }
    
    /* Bear Signal - Red tint glow */
    .ship-sprite-wrap.ship--bear {
      filter: drop-shadow(0 0 10px var(--red-alert)) 
              drop-shadow(0 0 20px rgba(255, 0, 64, 0.4));
    }
    
    /* Combined volatile + damaged = critical state */
    .ship-sprite-wrap.ship--volatile.ship--damaged {
      animation: sprite-jitter 0.08s steps(4) infinite, critical-flash 0.3s ease-in-out infinite;
    }
    
    @keyframes critical-flash {
      0%, 100% { filter: drop-shadow(0 0 8px var(--red-alert)); }
      50% { filter: drop-shadow(0 0 20px var(--red-alert)) brightness(1.2); }
    }

    /* ═══════════════════════════════════════════════════════════════════════
       BEHAVIOR STATUS BADGES - Hotline Miami Palette
       Visual state indicators below ship display
       ═══════════════════════════════════════════════════════════════════════ */
    
    .behavior-badges {
      display: flex;
      gap: 0.25rem;
      justify-content: center;
      margin-top: 0.25rem;
      padding: 0.25rem;
      background: var(--bg-void);
      border: 1px solid var(--magenta-ghost);
      font-size: 0.5rem;
      letter-spacing: 0.05em;
    }
    
    .behavior-badge {
      padding: 0.15rem 0.35rem;
      background: var(--bg-panel);
      border: 1px solid var(--magenta-ghost);
      color: var(--text-muted);
      text-transform: uppercase;
      font-family: var(--font-display);
      transition: all 0.2s ease;
    }
    
    /* Thrust states - Cyan for data */
    .behavior-badge[data-state="THRUST++"] {
      color: var(--cyan);
      border-color: var(--cyan);
      box-shadow: 0 0 4px rgba(0, 255, 255, 0.3);
    }
    .behavior-badge[data-state="THRUST+"] {
      color: var(--cyan);
      border-color: var(--cyan-dark);
    }
    .behavior-badge[data-state="DRIFT"] {
      color: var(--yellow);
      border-color: var(--yellow-dim);
    }
    .behavior-badge[data-state="FAIL"] {
      color: var(--magenta);
      border-color: var(--magenta);
      animation: badge-pulse 0.5s ease-in-out infinite;
    }
    
    /* Stability states */
    .behavior-badge[data-state="STABLE"] {
      color: var(--cyan);
      border-color: var(--cyan-dark);
    }
    .behavior-badge[data-state="ELEV"] {
      color: var(--yellow);
      border-color: var(--yellow-dim);
    }
    .behavior-badge[data-state="HIGH"] {
      color: var(--orange);
      border-color: var(--orange-dim);
    }
    .behavior-badge[data-state="EXTREME"] {
      color: var(--magenta);
      border-color: var(--magenta);
      animation: badge-pulse 0.3s ease-in-out infinite;
    }
    
    /* Hull states */
    .behavior-badge[data-state="HULL OK"] {
      color: var(--cyan);
      border-color: var(--cyan-dark);
    }
    .behavior-badge[data-state="STRESS"] {
      color: var(--yellow);
      border-color: var(--yellow-dim);
    }
    .behavior-badge[data-state="CRIT"] {
      color: var(--orange);
      border-color: var(--orange-dim);
    }
    .behavior-badge[data-state="HULL!"] {
      color: var(--magenta);
      border-color: var(--magenta);
      animation: badge-pulse 0.3s ease-in-out infinite;
    }
    
    @keyframes badge-pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* Telemetry bars - mini horizontal indicators (Miami palette) */
    .telemetry-bars {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin: 0.5rem 0;
      padding: 0.5rem;
      background: var(--bg-panel);
      border: 1px solid var(--magenta-ghost);
    }

    .telem-bar-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .telem-bar-label {
      font-size: 0.5rem;
      font-family: var(--font-display);
      letter-spacing: 0.05em;
      color: var(--text-muted);
      width: 52px;
      text-align: right;
      flex-shrink: 0;
    }

    .telem-bar {
      flex: 1;
      height: 6px;
      background: var(--bg-void);
      border: 1px solid var(--magenta-ghost);
      position: relative;
      overflow: hidden;
    }

    .telem-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      transition: width 0.3s ease;
    }

    /* Miami color scheme for telemetry bars */
    .telem-bar-fill.trend {
      background: linear-gradient(90deg, var(--magenta), var(--cyan)) !important;
    }
    
    .telem-bar-fill.momentum {
      background: linear-gradient(90deg, var(--cyan-dark), var(--cyan)) !important;
    }
    
    .telem-bar-fill.volatility {
      background: linear-gradient(90deg, var(--yellow-dim), var(--yellow)) !important;
    }

    .telem-bar-center {
      position: absolute;
      top: 0;
      left: 50%;
      width: 1px;
      height: 100%;
      background: var(--magenta);
      opacity: 0.5;
    }

    /* Telemetry Display - Miami Typography */
    .ship-telemetry {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      margin-top: 0.75rem;
      padding-top: 0.75rem;
      border-top: 1px solid var(--magenta-ghost);
    }

    .telemetry-item {
      text-align: center;
    }

    .telemetry-label {
      font-family: var(--font-display);
      font-size: 0.625rem;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-bottom: 0.25rem;
    }

    .telemetry-value {
      font-family: var(--font-display);
      font-size: 1rem;
      color: var(--cyan);
      text-shadow: 0 0 5px var(--cyan);
    }

    /* ═══════════════════════════════════════════════════════════════════════
       MACD BACKDROP - VHS Memory Ghost
       "Chart bends around ship" - not just behind, but BELONGING to it
       ═══════════════════════════════════════════════════════════════════════ */
    
    /* Original MACD container (hidden, replaced by backdrop) */
    .macd-mini-chart {
      display: none; /* Hide original - we use backdrop version */
    }

    /* MACD Backdrop - Behind ship, with VHS degradation */
    .macd-backdrop {
      position: absolute;
      inset: 0;
      z-index: 0;
      pointer-events: none;
      /* VHS DEGRADATION - ghosting, memory trails */
      opacity: 0.45;
      filter: blur(0.5px) contrast(1.15) saturate(1.3);
      mix-blend-mode: screen;
    }

    .macd-backdrop canvas {
      width: 100%;
      height: 100%;
      /* Let artifacts accumulate - don't fully clear */
      image-rendering: auto;
    }

    /* Zero line with VHS glow */
    .macd-backdrop-zero {
      position: absolute;
      left: 0;
      right: 0;
      top: 50%;
      height: 1px;
      background: var(--ui-primary);
      opacity: 0.4;
      box-shadow: 
        0 0 4px var(--ui-primary),
        0 0 8px rgba(255, 41, 117, 0.3);
      /* Subtle flicker */
      animation: zero-line-flicker 3s ease-in-out infinite;
    }

    @keyframes zero-line-flicker {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.25; }
      75% { opacity: 0.5; }
    }

    /* Ship display now has memory/hallucination quality */
    .ship-display {
      /* Override for VHS feel */
      overflow: hidden;
      background: 
        radial-gradient(ellipse at center, rgba(255, 41, 117, 0.03) 0%, transparent 70%),
        var(--bg-void);
    }

    /* MACD Signal badge (appears in ship header) */
    .macd-signal-badge {
      font-size: 0.5rem;
      font-family: var(--font-display);
      letter-spacing: 0.05em;
      padding: 0.1rem 0.35rem;
      border: 1px solid;
      text-transform: uppercase;
    }

    .macd-signal-badge.bullish {
      color: var(--cyan);
      border-color: var(--cyan);
      background: rgba(0, 255, 255, 0.1);
    }

    .macd-signal-badge.bearish {
      color: var(--magenta);
      border-color: var(--magenta);
      background: rgba(255, 41, 117, 0.1);
    }

    .macd-signal-badge.neutral {
      color: var(--text-muted);
      border-color: var(--border-dim);
    }

    /* Timeframe dots (moved to ship display area) */
    .timeframe-dots {
      position: absolute;
      bottom: 4px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 4px;
      z-index: 5;
    }

    .timeframe-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 1px solid var(--magenta-ghost);
      background: var(--bg-void);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .timeframe-dot:hover {
      border-color: var(--magenta);
    }

    .timeframe-dot.active {
      background: var(--cyan);
      border-color: var(--cyan);
      box-shadow: 0 0 6px var(--cyan);
    }

    /* ═══════════════════════════════════════════════════════════════════════
       SHIP JOURNEY VISUALIZATION - Miami Aesthetic
       ═══════════════════════════════════════════════════════════════════════ */

    /* 52-Week Range Indicator */
    .journey-range {
      margin-top: 0.5rem;
      padding: 0.4rem 0.5rem;
      background: var(--bg-panel);
      border: 1px solid var(--magenta-ghost);
    }

    .journey-range-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
    }

    .journey-range-label {
      font-family: var(--font-display);
      font-size: 0.5rem;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .journey-range-pct {
      font-family: var(--font-display);
      font-size: 0.6rem;
      color: var(--cyan);
      font-weight: bold;
    }

    .journey-range-bar {
      position: relative;
      height: 6px;
      background: linear-gradient(90deg, 
        var(--magenta) 0%, 
        var(--yellow) 35%,
        var(--cyan) 65%, 
        var(--cyan) 100%
      );
      border-radius: 3px;
      overflow: visible;
    }

    .journey-range-marker {
      position: absolute;
      top: -3px;
      width: 3px;
      height: 12px;
      background: #fff;
      border-radius: 1px;
      transform: translateX(-50%);
      box-shadow: 0 0 6px #fff, 0 0 10px var(--cyan);
    }

    .journey-range-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 0.2rem;
    }

    .journey-range-value {
      font-size: 0.5rem;
      color: var(--text-dim);
    }

    /* Historical Mood Ring - Return indicators */
    .journey-mood {
      display: flex;
      justify-content: center;
      gap: 0.35rem;
      margin-top: 0.5rem;
      padding: 0.3rem 0;
    }

    .mood-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.15rem;
    }

    .mood-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.2);
      transition: all 0.3s ease;
    }

    .mood-dot.positive {
      background: var(--green-neon);
      box-shadow: 0 0 6px var(--green-neon);
    }

    .mood-dot.negative {
      background: var(--red-alert);
      box-shadow: 0 0 6px var(--red-alert);
    }

    .mood-dot.neutral {
      background: var(--text-dim);
    }

    .mood-dot.strong-positive {
      background: var(--green-neon);
      box-shadow: 0 0 10px var(--green-neon), 0 0 20px var(--green-neon);
      animation: moodPulse 2s ease-in-out infinite;
    }

    .mood-dot.strong-negative {
      background: var(--red-alert);
      box-shadow: 0 0 10px var(--red-alert), 0 0 20px var(--red-alert);
      animation: moodPulse 2s ease-in-out infinite;
    }

    @keyframes moodPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .mood-label {
      font-size: 0.45rem;
      color: var(--text-dim);
      letter-spacing: 0.05em;
    }

    /* Veteran Badge */
    .veteran-badge {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      font-size: 0.6rem;
      padding: 0.15rem 0.3rem;
      background: rgba(255, 215, 0, 0.15);
      border: 1px solid rgba(255, 215, 0, 0.5);
      color: #ffd700;
      letter-spacing: 0.1em;
      text-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
    }

    .veteran-badge.apex {
      background: rgba(0, 255, 255, 0.15);
      border-color: var(--cyan);
      color: var(--cyan);
    }

    .veteran-badge.survivor {
      background: rgba(255, 41, 117, 0.15);
      border-color: var(--magenta);
      color: var(--magenta);
    }

    /* Strike Range Indicator */
    .strike-range {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.5rem;
      padding: 0.5rem;
      background: var(--bg-panel);
      border: 1px solid var(--border-dim);
    }

    .strike-bar {
      flex: 1;
      height: 8px;
      background: var(--bg-void);
      position: relative;
      border: 1px solid var(--border-dim);
    }

    .strike-marker {
      position: absolute;
      top: -3px;
      width: 4px;
      height: 14px;
      background: var(--yellow);
      box-shadow: 0 0 5px var(--yellow);
    }

    .strike-marker.current {
      background: var(--cyan);
      box-shadow: 0 0 10px var(--cyan);
    }

    .strike-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.625rem;
      color: var(--text-muted);
      margin-top: 0.25rem;
    }

    /* =========================================================================
       SIDEBAR - MISSION CONTROL
       ========================================================================= */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 0.75rem;
    }

    .stat-card {
      background: var(--bg-surface);
      border: 2px solid var(--border-dim);
      padding: 1rem;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--magenta);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: bold;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .stat-value.positive {
      color: var(--green-neon);
      text-shadow: 0 0 10px var(--green-neon);
    }

    .stat-value.negative {
      color: var(--red-alert);
      text-shadow: 0 0 10px var(--red-alert);
    }

    .stat-label {
      font-size: 0.625rem;
      letter-spacing: 0.15em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* Catalysts Panel */
    .catalyst-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .catalyst-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-surface);
      border: 1px solid var(--border-dim);
      border-left: 3px solid var(--magenta);
      transition: all 0.2s ease;
    }

    .catalyst-item:hover {
      border-color: var(--magenta);
      background: var(--bg-elevated);
    }

    .catalyst-item.high-impact {
      border-left-color: var(--red-alert);
    }

    .catalyst-date {
      font-size: 0.75rem;
      color: var(--text-muted);
      min-width: 70px;
    }

    .catalyst-info {
      flex: 1;
    }

    .catalyst-ticker {
      font-size: 0.875rem;
      font-weight: bold;
      color: var(--magenta);
    }

    .catalyst-event {
      font-size: 0.75rem;
      color: var(--text-dim);
    }

    .catalyst-impact {
      font-size: 0.625rem;
      letter-spacing: 0.1em;
      padding: 0.25rem 0.5rem;
      text-transform: uppercase;
    }

    .catalyst-impact.high {
      background: var(--red-alert);
      color: white;
    }

    .catalyst-impact.medium {
      background: var(--yellow);
      color: var(--bg-void);
    }

    /* Theme Breakdown */
    .theme-grid {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .theme-row {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.5rem 0.75rem;
      background: var(--bg-surface);
      border: 1px solid var(--border-dim);
    }

    .theme-icon {
      font-size: 1.25rem;
    }

    .theme-name {
      flex: 1;
      font-size: 0.875rem;
      color: var(--text-primary);
    }

    .theme-value {
      font-size: 0.875rem;
      color: var(--cyan);
    }

    .theme-bar {
      width: 60px;
      height: 6px;
      background: var(--bg-void);
      border: 1px solid var(--border-dim);
      position: relative;
      overflow: hidden;
    }

    .theme-bar-fill {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      background: var(--magenta);
      transition: width 0.3s ease;
    }

    /* =========================================================================
       LOADING SCREEN
       ========================================================================= */
    .loading-screen {
      position: fixed;
      inset: 0;
      background: var(--bg-void);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-title {
      font-size: 3rem;
      letter-spacing: 0.3em;
      color: var(--magenta);
      text-shadow: 0 0 20px var(--magenta), 0 0 40px var(--magenta-dark);
      margin-bottom: 0.5rem;
      animation: title-glitch 3s ease-in-out infinite;
    }

    @keyframes title-glitch {
      0%, 95%, 100% { text-shadow: 0 0 20px var(--magenta), 0 0 40px var(--magenta-dark); transform: translateX(0); }
      96% { text-shadow: -3px 0 var(--cyan), 3px 0 var(--magenta); transform: translateX(-2px); }
      97% { text-shadow: 3px 0 var(--cyan), -3px 0 var(--magenta); transform: translateX(2px); }
      98% { text-shadow: -3px 0 var(--cyan), 3px 0 var(--magenta); transform: translateX(-1px); }
    }

    .loading-subtitle {
      font-size: 0.875rem;
      letter-spacing: 0.5em;
      color: var(--text-dim);
      text-transform: uppercase;
      margin-bottom: 3rem;
    }

    .loading-bar-container {
      width: 300px;
      height: 4px;
      background: var(--border-dim);
      position: relative;
      overflow: hidden;
    }

    .loading-bar {
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 0%;
      background: var(--magenta);
      box-shadow: 0 0 10px var(--magenta), 0 0 20px var(--magenta-dark);
      transition: width 0.3s ease;
    }

    .loading-status {
      margin-top: 1rem;
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    /* =========================================================================
       RESPONSIVE
       ========================================================================= */
    /* =========================================================================
       MOBILE BURGER MENU - Hotline Miami Style
       "Command terminal - restricted access"
       ========================================================================= */
    
    /* Burger button - hidden on desktop, visible on mobile */
    .burger-btn {
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 44px;
      height: 44px;
      background: transparent;
      border: 2px solid var(--hm-magenta);
      cursor: pointer;
      position: relative;
      z-index: 1001;
      padding: 0;
    }
    
    .burger-btn:hover {
      background: rgba(255, 41, 117, 0.1);
      box-shadow: 0 0 15px rgba(255, 41, 117, 0.4);
    }
    
    .burger-btn:active {
      transform: scale(0.95);
    }
    
    /* Three-line hamburger icon */
    .burger-line {
      display: block;
      width: 20px;
      height: 2px;
      background: var(--hm-magenta);
      transition: all 0.2s steps(4);
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .burger-line:nth-child(1) { top: 12px; }
    .burger-line:nth-child(2) { top: 20px; }
    .burger-line:nth-child(3) { top: 28px; }
    
    /* X transformation when menu is open */
    .burger-btn.active .burger-line:nth-child(1) {
      top: 20px;
      transform: translateX(-50%) rotate(45deg);
    }
    
    .burger-btn.active .burger-line:nth-child(2) {
      opacity: 0;
      transform: translateX(-100%);
    }
    
    .burger-btn.active .burger-line:nth-child(3) {
      top: 20px;
      transform: translateX(-50%) rotate(-45deg);
    }
    
    /* Mobile Nav Overlay */
    .mobile-nav {
      display: none;
      position: fixed;
      top: 0;
      right: -100%;
      width: 280px;
      height: 100vh;
      background: var(--bg-panel);
      border-left: 3px solid var(--hm-magenta);
      z-index: 1000;
      transition: right 0.3s steps(8);
      overflow-y: auto;
      flex-direction: column;
    }
    
    /* VHS damage overlay on mobile nav */
    .mobile-nav::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        repeating-linear-gradient(
          0deg,
          transparent,
          transparent 2px,
          rgba(255, 41, 117, 0.02) 2px,
          rgba(255, 41, 117, 0.02) 4px
        );
      pointer-events: none;
      z-index: 1;
    }
    
    /* Glow effect on left border */
    .mobile-nav::after {
      content: '';
      position: absolute;
      top: 0;
      left: -3px;
      width: 3px;
      height: 100%;
      background: var(--hm-magenta);
      box-shadow: 
        0 0 20px var(--hm-magenta),
        0 0 40px rgba(255, 41, 117, 0.5);
    }
    
    .mobile-nav.open {
      right: 0;
    }
    
    /* Mobile nav header */
    .mobile-nav-header {
      padding: 1rem;
      border-bottom: 1px solid var(--border-dim);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .mobile-nav-title {
      font-size: 0.75rem;
      letter-spacing: 0.2em;
      color: var(--hm-cyan);
      text-transform: uppercase;
    }
    
    /* Mobile nav items */
    .mobile-nav-items {
      padding: 0.5rem 0;
      position: relative;
      z-index: 2;
    }
    
    .mobile-nav-btn {
      display: block;
      width: 100%;
      padding: 1rem 1.5rem;
      font-family: var(--font-main);
      font-size: 1.25rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-primary);
      background: transparent;
      border: none;
      border-bottom: 1px solid var(--border-dim);
      text-align: left;
      cursor: pointer;
      transition: all 0.1s;
      position: relative;
    }
    
    .mobile-nav-btn::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 3px;
      height: 100%;
      background: transparent;
      transition: background 0.1s;
    }
    
    .mobile-nav-btn:hover,
    .mobile-nav-btn:focus {
      background: rgba(255, 41, 117, 0.1);
      color: var(--hm-magenta);
    }
    
    .mobile-nav-btn:hover::before,
    .mobile-nav-btn:focus::before {
      background: var(--hm-magenta);
    }
    
    /* Status section in mobile nav */
    .mobile-nav-status {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--border-dim);
      margin-top: auto;
    }
    
    .mobile-nav-status-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 0;
      font-size: 0.875rem;
      color: var(--text-dim);
    }
    
    .mobile-nav-status-value {
      color: var(--hm-cyan);
    }
    
    /* Backdrop overlay */
    .mobile-nav-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .mobile-nav-backdrop.visible {
      display: block;
      opacity: 1;
    }

    @media (max-width: 768px) {
      /* Show burger, hide desktop nav items */
      .burger-btn {
        display: flex;
      }
      
      .mobile-nav {
        display: flex;
      }
      
      .header {
        flex-direction: row;
        justify-content: space-between;
        padding: 0.75rem 1rem;
      }
      
      .header-brand {
        gap: 0.5rem;
      }
      
      .header-logo {
        font-size: 1.5rem;
      }
      
      .header-title {
        font-size: 1.25rem;
      }
      
      .header-subtitle {
        display: none;
      }

      /* Hide desktop nav elements on mobile */
      .header-status {
        display: none;
      }

      .main-content {
        padding: 1rem;
      }

      .fleet-grid {
        grid-template-columns: 1fr;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .mobile-nav {
        width: 100%;
        right: -100%;
      }
      
      .header-title {
        font-size: 1rem;
      }
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      .vhs-noise, .scanlines { display: none; }
    }

    /* ═══════════════════════════════════════════════════════════════════════════
       REGISTRY TERMINAL - Bloomberg-style ship reference sheet
       ═══════════════════════════════════════════════════════════════════════════ */
    
    .registry-modal {
      display: none;
      position: fixed;
      inset: 0;
      z-index: 10000;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(4px);
      animation: registryFadeIn 0.2s ease;
    }

    .registry-modal.open {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @keyframes registryFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    .registry-terminal {
      width: 95%;
      max-width: 1000px;
      max-height: 85vh;
      background: #0a0e0a;
      border: 2px solid var(--hm-cyan);
      box-shadow: 
        0 0 40px rgba(0, 255, 255, 0.2),
        inset 0 0 60px rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      font-family: 'IBM Plex Mono', 'VT323', monospace;
      position: relative;
    }

    .registry-terminal::before {
      content: '';
      position: absolute;
      inset: 0;
      background: repeating-linear-gradient(
        0deg,
        transparent,
        transparent 2px,
        rgba(0, 255, 255, 0.02) 2px,
        rgba(0, 255, 255, 0.02) 4px
      );
      pointer-events: none;
    }

    .registry-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.5rem 1rem;
      background: linear-gradient(90deg, #001a1a, #0a1a0a);
      border-bottom: 1px solid var(--hm-cyan);
    }

    .registry-title {
      font-size: 0.9rem;
      color: var(--hm-cyan);
      letter-spacing: 0.15em;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .registry-title-icon {
      font-size: 1.1rem;
    }

    .registry-meta {
      font-size: 0.7rem;
      color: #4a7a4a;
      letter-spacing: 0.1em;
    }

    .registry-close {
      font-family: inherit;
      font-size: 1.2rem;
      color: var(--hm-magenta);
      background: transparent;
      border: 1px solid var(--hm-magenta);
      width: 28px;
      height: 28px;
      cursor: pointer;
      transition: all 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .registry-close:hover {
      background: var(--hm-magenta);
      color: #0a0e0a;
    }

    .registry-toolbar {
      display: flex;
      gap: 1rem;
      padding: 0.5rem 1rem;
      background: #0d120d;
      border-bottom: 1px solid #1a2a1a;
      font-size: 0.7rem;
    }

    .registry-toolbar-item {
      color: #4a7a4a;
      display: flex;
      align-items: center;
      gap: 0.3rem;
    }

    .registry-toolbar-value {
      color: var(--hm-cyan);
    }

    .registry-content {
      flex: 1;
      overflow: auto;
      padding: 0;
    }

    .registry-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.75rem;
    }

    .registry-table th {
      position: sticky;
      top: 0;
      background: #0d120d;
      color: var(--hm-cyan);
      font-weight: 500;
      text-align: left;
      padding: 0.6rem 0.75rem;
      border-bottom: 1px solid var(--hm-cyan);
      letter-spacing: 0.1em;
      font-size: 0.65rem;
      z-index: 10;
    }

    .registry-table td {
      padding: 0.5rem 0.75rem;
      border-bottom: 1px solid #1a2a1a;
      vertical-align: top;
    }

    .registry-table tr:hover {
      background: rgba(0, 255, 255, 0.03);
    }

    .registry-table tr:nth-child(even) {
      background: rgba(0, 20, 0, 0.3);
    }

    .registry-table tr:nth-child(even):hover {
      background: rgba(0, 255, 255, 0.05);
    }

    .registry-ticker {
      font-family: 'VT323', monospace;
      font-size: 1rem;
      color: var(--hm-magenta);
      font-weight: bold;
    }

    .registry-name {
      color: #88aa88;
      font-size: 0.7rem;
    }

    .registry-designation {
      color: #4a6a4a;
      font-size: 0.65rem;
      font-family: 'IBM Plex Mono', monospace;
    }

    .registry-class {
      color: var(--hm-cyan);
      font-size: 0.7rem;
      letter-spacing: 0.05em;
    }

    .registry-tier {
      display: inline-block;
      width: 20px;
      height: 20px;
      line-height: 20px;
      text-align: center;
      font-family: 'VT323', monospace;
      font-size: 0.9rem;
      font-weight: bold;
      border: 1px solid;
    }

    .registry-tier.tier-S { color: #ffaa33; border-color: #ffaa33; background: rgba(255, 170, 51, 0.1); }
    .registry-tier.tier-A { color: #33ff99; border-color: #33ff99; background: rgba(51, 255, 153, 0.1); }
    .registry-tier.tier-B { color: #4ecdc4; border-color: #4ecdc4; background: rgba(78, 205, 196, 0.1); }
    .registry-tier.tier-C { color: #888888; border-color: #888888; background: rgba(136, 136, 136, 0.1); }
    .registry-tier.tier-\\? { color: #ff6b6b; border-color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }

    .registry-specialty {
      color: #6a8a6a;
      font-size: 0.65rem;
      letter-spacing: 0.05em;
    }

    .registry-tagline {
      color: #88aa88;
      font-size: 0.7rem;
      line-height: 1.4;
      max-width: 300px;
    }

    .registry-footer {
      padding: 0.5rem 1rem;
      background: #0d120d;
      border-top: 1px solid #1a2a1a;
      font-size: 0.65rem;
      color: #4a6a4a;
      display: flex;
      justify-content: space-between;
    }

    .registry-footer kbd {
      background: #1a2a1a;
      padding: 0.1rem 0.4rem;
      border-radius: 2px;
      color: var(--hm-cyan);
    }

    @media (max-width: 768px) {
      .registry-terminal {
        width: 100%;
        max-width: none;
        max-height: 100vh;
        border: none;
        border-radius: 0;
      }

      .registry-table {
        font-size: 0.65rem;
      }

      .registry-table th,
      .registry-table td {
        padding: 0.4rem 0.5rem;
      }

      .registry-tagline {
        max-width: 150px;
        font-size: 0.6rem;
      }

      .registry-toolbar {
        flex-wrap: wrap;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- CRT App Shell - Miami Chromatic + Watercolor layers -->
  <div class="app-shell watercolor-ambient">
    <!-- Layer 0: Base gradient (static) -->
    <div class="parallax-layer layer-bg" data-depth="0"></div>
    
    <!-- Layer 1: Watercolor ambient wash (slow parallax) -->
    <div class="watercolor-layer parallax-layer" data-depth="0.1"></div>
    
    <!-- Layer 2: CRT effects (slight parallax) -->
    <div class="crt-layer">
      <div class="crt-noise parallax-layer" data-depth="0.15"></div>
    </div>
    
    <!-- Layer 3: UI Content -->
    <div class="ui-layer">

  <!-- Loading handled by TelemetryLockIn module -->
  <!-- Lock-in screen is created dynamically by js/ui/telemetry-lockin.js -->

  <!-- Main App -->
  <div class="app">
    <header class="header">
      <div class="header-brand">
        <span class="header-logo">[SC]</span>
        <div>
          <h1 class="header-title">SPACE CAPITAL</h1>
          <div class="header-subtitle">Fleet Command // Sector Alpha</div>
        </div>
      </div>
      <div class="header-status">
        <button id="pilotBtn" class="moduleViewer__trigger pilot-btn" title="Switch Pilot">
          <span class="pilot-avatar-mini" id="pilotAvatarMini">[P]</span>
          <span id="pilotCallsign">GUEST</span>
        </button>
        <button id="openHangarBtn" class="moduleViewer__trigger">HANGAR</button>
        <button id="openDerivativesBtn" class="moduleViewer__trigger">DERIVATIVES</button>
        <button id="openRegistryBtn" class="moduleViewer__trigger" style="color: var(--hm-cyan);">:: REGISTRY</button>
        <button id="openPositionsBtn" class="moduleViewer__trigger">POSITIONS</button>
        <button id="openModulesBtn" class="moduleViewer__trigger">MODULES</button>
        <div class="status-item">
          <span class="status-dot online" id="system-status"></span>
          <span>SYSTEMS ONLINE</span>
        </div>
        <div class="status-item">
          <span class="status-dot warning" id="market-status"></span>
          <span id="market-status-text">MARKET CLOSED</span>
        </div>
        <div class="status-item">
          <span style="color: var(--text-muted);">LAST SYNC:</span>
          <span id="last-update" style="color: var(--cyan);">--:--:--</span>
        </div>
      </div>
      <!-- Mobile Burger Menu Button -->
      <button class="burger-btn" id="burgerBtn" aria-label="Open navigation menu" aria-expanded="false">
        <span class="burger-line"></span>
        <span class="burger-line"></span>
        <span class="burger-line"></span>
      </button>
    </header>

    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-backdrop" id="mobileNavBackdrop"></div>
    <nav class="mobile-nav" id="mobileNav" aria-label="Mobile navigation">
      <div class="mobile-nav-header">
        <span class="mobile-nav-title">// COMMAND MENU</span>
      </div>
      <div class="mobile-nav-items">
        <button class="mobile-nav-btn" data-action="pilot">PILOT</button>
        <button class="mobile-nav-btn" data-action="hangar">HANGAR</button>
        <button class="mobile-nav-btn" data-action="derivatives">DERIVATIVES</button>
        <button class="mobile-nav-btn" data-action="registry">REGISTRY</button>
        <button class="mobile-nav-btn" data-action="positions">POSITIONS</button>
        <button class="mobile-nav-btn" data-action="modules">MODULES</button>
      </div>
      <div class="mobile-nav-status">
        <div class="mobile-nav-status-item">
          <span>SYSTEMS</span>
          <span class="mobile-nav-status-value" id="mobileSystemStatus">ONLINE</span>
        </div>
        <div class="mobile-nav-status-item">
          <span>MARKET</span>
          <span class="mobile-nav-status-value" id="mobileMarketStatus">CLOSED</span>
        </div>
        <div class="mobile-nav-status-item">
          <span>LAST SYNC</span>
          <span class="mobile-nav-status-value" id="mobileLastUpdate">--:--:--</span>
        </div>
      </div>
    </nav>

    <main class="main-content">
      <!-- Fleet Hangar -->
      <div class="panel panel-corners">
        <div class="panel-header">
          <div>
            <div class="panel-label">// HANGAR BAY</div>
            <h2 class="panel-title">ACTIVE FLEET</h2>
          </div>
          <div style="font-size: 0.875rem; color: var(--text-dim);">
            <span id="ship-count">0</span> VESSELS DEPLOYED
          </div>
        </div>
        
        <!-- Fleet Power HUD - Positions Overview -->
        <div class="fleet-power-hud empty" id="fleet-power-hud">
          <div class="fleet-power-stat">
            <span class="fleet-power-label">EXPOSURE</span>
            <span class="fleet-power-value" id="hud-exposure">--</span>
          </div>
          <div class="fleet-power-stat">
            <span class="fleet-power-label">OPTIONS</span>
            <span class="fleet-power-value neutral" id="hud-options-ratio">--</span>
          </div>
          <div class="fleet-power-stat">
            <span class="fleet-power-label">TOP 3</span>
            <div class="fleet-concentration" id="hud-concentration">
              <span class="fleet-concentration-item">--</span>
            </div>
          </div>
          <div class="fleet-power-stat">
            <span class="fleet-power-label">P&L</span>
            <span class="fleet-power-value" id="hud-pnl">--</span>
          </div>
        </div>
        
        <!-- Fleet Comms - Risk alerts -->
        <div class="fleet-comms" id="fleet-comms" style="display: none;">
          <div class="fleet-comms-header">// COMMS</div>
          <div id="fleet-comms-lines"></div>
        </div>
        
        <div class="panel-body">
          <div class="fleet-grid" id="fleet-grid">
            <!-- Ships rendered here -->
          </div>
        </div>
      </div>

      <!-- Sidebar -->
      <div class="sidebar">
        <!-- Portfolio Stats -->
        <div class="panel panel-corners">
          <div class="panel-header">
            <div>
              <div class="panel-label">// TELEMETRY</div>
              <h2 class="panel-title">FLEET STATUS</h2>
            </div>
          </div>
          <div class="panel-body">
            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-value" id="total-value">$0</div>
                <div class="stat-label">FLEET VALUE</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="total-pnl">$0</div>
                <div class="stat-label">TOTAL P&L</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="total-delta">0.00</div>
                <div class="stat-label">NET DELTA</div>
              </div>
              <div class="stat-card">
                <div class="stat-value" id="days-to-expiry">0</div>
                <div class="stat-label">DAYS TO EXP</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Theme Breakdown -->
        <div class="panel panel-corners">
          <div class="panel-header">
            <div>
              <div class="panel-label">// SECTOR ANALYSIS</div>
              <h2 class="panel-title">DEPLOYMENT</h2>
            </div>
          </div>
          <div class="panel-body">
            <div class="theme-grid" id="theme-grid">
              <!-- Themes rendered here -->
            </div>
          </div>
        </div>

        <!-- Catalysts -->
        <div class="panel panel-corners">
          <div class="panel-header">
            <div>
              <div class="panel-label">// INTEL FEED</div>
              <h2 class="panel-title">UPCOMING EVENTS</h2>
            </div>
          </div>
          <div class="panel-body">
            <div class="catalyst-list" id="catalyst-list">
              <!-- Catalysts rendered here -->
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // =========================================================================
    // MOBILE BURGER MENU - Command Terminal Access
    // =========================================================================
    
    (function initBurgerMenu() {
      const burgerBtn = document.getElementById('burgerBtn');
      const mobileNav = document.getElementById('mobileNav');
      const backdrop = document.getElementById('mobileNavBackdrop');
      
      if (!burgerBtn || !mobileNav || !backdrop) return;
      
      function openMenu() {
        burgerBtn.classList.add('active');
        burgerBtn.setAttribute('aria-expanded', 'true');
        mobileNav.classList.add('open');
        backdrop.classList.add('visible');
        document.body.style.overflow = 'hidden';
      }
      
      function closeMenu() {
        burgerBtn.classList.remove('active');
        burgerBtn.setAttribute('aria-expanded', 'false');
        mobileNav.classList.remove('open');
        backdrop.classList.remove('visible');
        document.body.style.overflow = '';
      }
      
      function toggleMenu() {
        if (mobileNav.classList.contains('open')) {
          closeMenu();
        } else {
          openMenu();
        }
      }
      
      // Burger button click
      burgerBtn.addEventListener('click', toggleMenu);
      
      // Backdrop click closes menu
      backdrop.addEventListener('click', closeMenu);
      
      // ESC key closes menu
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && mobileNav.classList.contains('open')) {
          closeMenu();
        }
      });
      
      // Mobile nav button actions
      const actionMap = {
        'pilot': () => document.getElementById('pilotBtn')?.click(),
        'hangar': () => document.getElementById('openHangarBtn')?.click(),
        'derivatives': () => document.getElementById('openDerivativesBtn')?.click(),
        'registry': () => document.getElementById('openRegistryBtn')?.click(),
        'positions': () => document.getElementById('openPositionsBtn')?.click(),
        'modules': () => document.getElementById('openModulesBtn')?.click()
      };
      
      mobileNav.querySelectorAll('.mobile-nav-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const action = btn.dataset.action;
          if (actionMap[action]) {
            closeMenu();
            // Small delay to allow menu close animation
            setTimeout(() => actionMap[action](), 100);
          }
        });
      });
      
      // Sync mobile status with desktop status
      function syncMobileStatus() {
        const marketText = document.getElementById('market-status-text');
        const lastUpdate = document.getElementById('last-update');
        const mobileMarket = document.getElementById('mobileMarketStatus');
        const mobileLast = document.getElementById('mobileLastUpdate');
        
        if (marketText && mobileMarket) {
          mobileMarket.textContent = marketText.textContent.replace('MARKET ', '');
        }
        if (lastUpdate && mobileLast) {
          mobileLast.textContent = lastUpdate.textContent;
        }
      }
      
      // Sync status periodically
      setInterval(syncMobileStatus, 5000);
      syncMobileStatus();
    })();

    // =========================================================================
    // DATA & CONFIGURATION
    // =========================================================================
    
    // Ticker metadata - themes, colors, ship classes
    const TICKER_CONFIG = {
      // Space & Satellites
      'RKLB': { theme: 'Space', icon: 'RK', color: '#FF2975', class: 'INTERCEPTOR', sin: 'OBSESSION' },
      'LUNR': { theme: 'Space', icon: 'LN', color: '#9D4EDD', class: 'EXPLORER', sin: 'FAITH' },
      'ASTS': { theme: 'Space', icon: 'AS', color: '#00FFFF', class: 'CRUISER', sin: 'AMBITION' },
      'BKSY': { theme: 'Space', icon: 'BK', color: '#FF69B4', class: 'SCOUT', sin: 'VIGILANCE' },
      'RDW': { theme: 'Space', icon: 'RD', color: '#00CCCC', class: 'ENGINEER', sin: 'CRAFT' },
      'PL': { theme: 'Space', icon: 'PL', color: '#B8986B', class: 'SURVEYOR', sin: 'WISDOM' },
      
      // Air Mobility / eVTOL
      'ACHR': { theme: 'Air Mobility', icon: 'AC', color: '#39FF14', class: 'STRIKER', sin: 'VISION' },
      'JOBY': { theme: 'Air Mobility', icon: 'JB', color: '#FFE600', class: 'TRANSPORT', sin: 'PATIENCE' },
      'EVEX': { theme: 'Air Mobility', icon: 'EV', color: '#C45C5C', class: 'PROTOTYPE', sin: 'HOPE' },
      
      // Defense & Aerospace
      'KTOS': { theme: 'Defense', icon: 'KT', color: '#FF4444', class: 'FIGHTER', sin: 'PRECISION' },
      'LHX': { theme: 'Defense', icon: 'LX', color: '#4488FF', class: 'SENTINEL', sin: 'DUTY' },
      'RTX': { theme: 'Defense', icon: 'RX', color: '#888888', class: 'CARRIER', sin: 'POWER' },
      'GE': { theme: 'Defense', icon: 'GE', color: '#44AAFF', class: 'TITAN', sin: 'LEGACY' },
      
      // Tech & Other
      'COHR': { theme: 'Tech', icon: 'CH', color: '#AA44FF', class: 'PHANTOM', sin: 'CLARITY' },
      'GME': { theme: 'Meme', icon: 'GM', color: '#FF6B35', class: 'BERSERKER', sin: 'RAGE' },
      
      // Benchmarks
      'XAR': { theme: 'Benchmark', icon: 'XR', color: '#666677', class: 'FLAGSHIP', sin: 'INDEX' },
      'SPY': { theme: 'Benchmark', icon: 'SP', color: '#4466AA', class: 'COMMAND', sin: 'MARKET' }
    };

    const DEFAULT_CONFIG = { theme: 'Other', icon: 'XX', color: '#888899', class: 'UNKNOWN', sin: 'MYSTERY' };

    // Ship SVG generator based on class type
    function generateShipSVG(shipClass, color) {
      const ships = {
        'INTERCEPTOR': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 4L40 20L48 28L48 44L40 48L32 60L24 48L16 44L16 28L24 20L32 4Z" fill="${color}" fill-opacity="0.3"/>
            <path d="M32 4L40 20L48 28L48 44L40 48L32 60L24 48L16 44L16 28L24 20L32 4Z" stroke="${color}" stroke-width="2"/>
            <path d="M32 16L36 24L40 28V36L36 38L32 44L28 38L24 36V28L28 24L32 16Z" fill="${color}"/>
            <circle cx="32" cy="28" r="4" fill="#000" stroke="${color}"/>
          </svg>`,
        'EXPLORER': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="32" cy="32" rx="24" ry="12" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <ellipse cx="32" cy="32" rx="16" ry="8" fill="${color}"/>
            <circle cx="32" cy="32" r="6" fill="#000" stroke="${color}" stroke-width="2"/>
            <path d="M32 8V20M32 44V56" stroke="${color}" stroke-width="2"/>
          </svg>`,
        'CRUISER': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="20" y="12" width="24" height="40" rx="4" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <rect x="24" y="16" width="16" height="12" fill="${color}"/>
            <rect x="12" y="24" width="8" height="20" fill="${color}" fill-opacity="0.5" stroke="${color}"/>
            <rect x="44" y="24" width="8" height="20" fill="${color}" fill-opacity="0.5" stroke="${color}"/>
            <circle cx="32" cy="40" r="4" fill="#000" stroke="${color}"/>
          </svg>`,
        'STRIKER': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 8L44 24L52 32L44 40L32 56L20 40L12 32L20 24L32 8Z" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <path d="M32 16L40 28L32 40L24 28L32 16Z" fill="${color}"/>
            <circle cx="32" cy="28" r="4" fill="#000" stroke="${color}"/>
          </svg>`,
        'TRANSPORT': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="16" y="16" width="32" height="32" rx="2" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <rect x="20" y="20" width="24" height="16" fill="${color}"/>
            <rect x="24" y="40" width="6" height="8" fill="${color}"/>
            <rect x="34" y="40" width="6" height="8" fill="${color}"/>
            <circle cx="32" cy="28" r="4" fill="#000" stroke="${color}"/>
          </svg>`,
        'BERSERKER': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 4L48 20V44L32 60L16 44V20L32 4Z" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <path d="M32 12L44 24V40L32 52L20 40V24L32 12Z" fill="${color}"/>
            <path d="M24 28L32 20L40 28L32 36L24 28Z" fill="#000" stroke="${color}"/>
            <path d="M8 32H16M48 32H56" stroke="${color}" stroke-width="3"/>
          </svg>`,
        'SCOUT': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="32" cy="32" r="20" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <circle cx="32" cy="32" r="12" fill="${color}"/>
            <circle cx="32" cy="32" r="6" fill="#000" stroke="${color}" stroke-width="2"/>
            <path d="M32 8V16M32 48V56M8 32H16M48 32H56" stroke="${color}" stroke-width="2"/>
          </svg>`,
        'ENGINEER': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="16" y="12" width="32" height="40" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <rect x="20" y="16" width="8" height="8" fill="${color}"/>
            <rect x="36" y="16" width="8" height="8" fill="${color}"/>
            <rect x="20" y="28" width="24" height="4" fill="${color}"/>
            <rect x="20" y="36" width="24" height="4" fill="${color}"/>
            <rect x="20" y="44" width="24" height="4" fill="${color}"/>
          </svg>`,
        'SURVEYOR': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 8L56 32L32 56L8 32L32 8Z" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <path d="M32 16L48 32L32 48L16 32L32 16Z" fill="${color}"/>
            <circle cx="32" cy="32" r="6" fill="#000" stroke="${color}" stroke-width="2"/>
          </svg>`,
        'PROTOTYPE': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 4L40 16L52 20L56 32L52 44L40 48L32 60L24 48L12 44L8 32L12 20L24 16L32 4Z" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <circle cx="32" cy="32" r="12" fill="${color}"/>
            <circle cx="32" cy="32" r="6" fill="#000" stroke="${color}" stroke-width="2"/>
          </svg>`,
        'FIGHTER': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 4L36 16L48 12L52 24L56 32L52 40L48 52L36 48L32 60L28 48L16 52L12 40L8 32L12 24L16 12L28 16L32 4Z" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <path d="M32 16L40 24V40L32 48L24 40V24L32 16Z" fill="${color}"/>
            <circle cx="32" cy="32" r="4" fill="#000" stroke="${color}"/>
            <path d="M20 20L12 12M44 20L52 12M20 44L12 52M44 44L52 52" stroke="${color}" stroke-width="2"/>
          </svg>`,
        'SENTINEL': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 8L52 20V44L32 56L12 44V20L32 8Z" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <path d="M32 16L44 24V40L32 48L20 40V24L32 16Z" fill="${color}"/>
            <rect x="28" y="24" width="8" height="16" fill="#000" stroke="${color}"/>
            <circle cx="32" cy="32" r="3" fill="${color}"/>
          </svg>`,
        'CARRIER': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="12" y="20" width="40" height="24" rx="2" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <rect x="16" y="24" width="32" height="16" fill="${color}"/>
            <rect x="20" y="28" width="6" height="8" fill="#000"/>
            <rect x="29" y="28" width="6" height="8" fill="#000"/>
            <rect x="38" y="28" width="6" height="8" fill="#000"/>
            <path d="M32 12V20M32 44V52" stroke="${color}" stroke-width="2"/>
          </svg>`,
        'TITAN': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="16" y="8" width="32" height="48" rx="4" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <rect x="20" y="12" width="24" height="20" fill="${color}"/>
            <circle cx="32" cy="22" r="6" fill="#000" stroke="${color}" stroke-width="2"/>
            <rect x="8" y="20" width="8" height="24" fill="${color}" fill-opacity="0.5" stroke="${color}"/>
            <rect x="48" y="20" width="8" height="24" fill="${color}" fill-opacity="0.5" stroke="${color}"/>
            <rect x="24" y="40" width="16" height="12" fill="${color}"/>
          </svg>`,
        'PHANTOM': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 4L44 16L56 28L52 40L44 52L32 60L20 52L12 40L8 28L20 16L32 4Z" fill="${color}" fill-opacity="0.2" stroke="${color}" stroke-width="1" stroke-dasharray="4 2"/>
            <path d="M32 16L40 24L44 32L40 40L32 48L24 40L20 32L24 24L32 16Z" fill="${color}" fill-opacity="0.5"/>
            <circle cx="32" cy="32" r="6" fill="${color}"/>
            <circle cx="32" cy="32" r="3" fill="#000"/>
          </svg>`,
        'FLAGSHIP': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M32 4L48 16L56 32L48 48L32 60L16 48L8 32L16 16L32 4Z" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <path d="M32 12L44 20L48 32L44 44L32 52L20 44L16 32L20 20L32 12Z" fill="${color}"/>
            <path d="M32 20L40 28L40 36L32 44L24 36L24 28L32 20Z" fill="#000" stroke="${color}"/>
            <circle cx="32" cy="32" r="4" fill="${color}"/>
          </svg>`,
        'COMMAND': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="32" cy="32" r="24" fill="${color}" fill-opacity="0.2" stroke="${color}" stroke-width="2"/>
            <circle cx="32" cy="32" r="16" fill="${color}" fill-opacity="0.4" stroke="${color}" stroke-width="2"/>
            <circle cx="32" cy="32" r="8" fill="${color}"/>
            <circle cx="32" cy="32" r="4" fill="#000" stroke="${color}"/>
            <path d="M32 4V12M32 52V60M4 32H12M52 32H60" stroke="${color}" stroke-width="2"/>
          </svg>`,
        'UNKNOWN': `
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="16" y="16" width="32" height="32" fill="${color}" fill-opacity="0.3" stroke="${color}" stroke-width="2"/>
            <text x="32" y="38" text-anchor="middle" fill="${color}" font-size="16" font-family="monospace">?</text>
          </svg>`
      };
      return ships[shipClass] || ships['UNKNOWN'];
    }

    // Calculate strike position as percentage
    function calculateStrikePosition(current, strike, range = 0.5) {
      const min = strike * (1 - range);
      const max = strike * (1 + range);
      const position = ((current - min) / (max - min)) * 100;
      return Math.max(0, Math.min(100, position));
    }

    // Format currency
    function formatCurrency(amount) {
      const prefix = amount >= 0 ? '$' : '-$';
      return prefix + Math.abs(amount).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }
    
    // Format compact value for position chips (e.g., 11645 -> "11.6k")
    function formatCompactValue(amount) {
      const abs = Math.abs(amount);
      if (abs >= 1000000) return (amount / 1000000).toFixed(1) + 'M';
      if (abs >= 1000) return (amount / 1000).toFixed(1) + 'k';
      return amount.toFixed(0);
    }

    // =========================================================================
    // RENDERING
    // =========================================================================

    // Helper to get mood class based on return percentage
    function getMoodClass(returnPct) {
      if (returnPct >= 20) return 'strong-positive';
      if (returnPct >= 5) return 'positive';
      if (returnPct <= -20) return 'strong-negative';
      if (returnPct <= -5) return 'negative';
      return 'neutral';
    }

    // Render the journey visualization (52w range + mood ring)
    function renderJourneyVisualization(position) {
      const history = position.history;
      if (!history) return '';

      const { high_52w, low_52w, return_1d, return_1w, return_1m, return_3m, return_1y, daily_count } = history;
      const currentPrice = position.stock_price;

      // Calculate position in 52-week range (0-100%)
      const range = high_52w - low_52w;
      const rangePosition = range > 0 ? ((currentPrice - low_52w) / range) * 100 : 50;
      const clampedPosition = Math.max(0, Math.min(100, rangePosition));

      // Determine veteran status
      let veteranBadge = '';
      if (clampedPosition >= 95) {
        veteranBadge = '<div class="veteran-badge apex">APEX</div>';
      } else if (return_1y <= -40) {
        veteranBadge = '<div class="veteran-badge survivor">SURVIVOR</div>';
      } else if (daily_count >= 500) {
        veteranBadge = '<div class="veteran-badge">VETERAN</div>';
      }

      return `
        ${veteranBadge}
        
        <!-- Historical Mood Ring -->
        <div class="journey-mood" title="Performance over time">
          <div class="mood-indicator">
            <div class="mood-dot ${getMoodClass(return_1d)}" title="1D: ${return_1d >= 0 ? '+' : ''}${return_1d.toFixed(1)}%"></div>
            <span class="mood-label">1D</span>
          </div>
          <div class="mood-indicator">
            <div class="mood-dot ${getMoodClass(return_1w)}" title="1W: ${return_1w >= 0 ? '+' : ''}${return_1w.toFixed(1)}%"></div>
            <span class="mood-label">1W</span>
          </div>
          <div class="mood-indicator">
            <div class="mood-dot ${getMoodClass(return_1m)}" title="1M: ${return_1m >= 0 ? '+' : ''}${return_1m.toFixed(1)}%"></div>
            <span class="mood-label">1M</span>
          </div>
          <div class="mood-indicator">
            <div class="mood-dot ${getMoodClass(return_3m)}" title="3M: ${return_3m >= 0 ? '+' : ''}${return_3m.toFixed(1)}%"></div>
            <span class="mood-label">3M</span>
          </div>
        </div>

        <!-- 52-Week Range Indicator -->
        <div class="journey-range" title="Position in 52-week range">
          <div class="journey-range-header">
            <span class="journey-range-label">52W RANGE</span>
            <span class="journey-range-pct">${clampedPosition.toFixed(0)}%</span>
          </div>
          <div class="journey-range-bar">
            <div class="journey-range-marker" style="left: ${clampedPosition}%;"></div>
          </div>
          <div class="journey-range-labels">
            <span class="journey-range-value">$${low_52w.toFixed(2)}</span>
            <span class="journey-range-value">$${high_52w.toFixed(2)}</span>
          </div>
        </div>
      `;
    }

    function renderShipCard(position) {
      const config = TICKER_CONFIG[position.ticker] || DEFAULT_CONFIG;
      
      // Position-based P&L (only if we have a position)
      const hasPosition = position.contracts > 0 && position.entry_cost > 0;
      let pnl = 0, pnlPct = 0, value = 0;
      
      if (hasPosition) {
        const cost = position.entry_cost * position.contracts * 100;
        value = position.current_price * position.contracts * 100;
        pnl = value - cost;
        pnlPct = cost > 0 ? (pnl / cost * 100) : 0;
      }
      
      // Use daily change if no position P&L
      const displayPct = hasPosition ? pnlPct : position.chgPct;
      const pnlClass = displayPct >= 0 ? 'positive' : 'negative';
      
      // ═══════════════════════════════════════════════════════════════════
      // POSITION INTEGRATION - Get ownership data from PositionsStore
      // ═══════════════════════════════════════════════════════════════════
      const posChip = window.PositionsStore?.getPositionChip(position.ticker);
      const fleetStats = window.PositionsStore?.getFleetStats() || { hasPositions: false };
      const isOwned = posChip?.hasPosition || false;
      const visualWeight = window.PositionsStore?.getVisualWeight(position.ticker) || 0.5;
      const riskMetrics = window.PositionsStore?.getRiskMetrics(position.ticker) || { concentration: 0, optionRatio: 0, riskLevel: 'none' };
      
      // Ownership state classes
      // Only apply ghost state if user has imported positions (otherwise all ships look normal)
      const ownershipClass = fleetStats.hasPositions 
        ? (isOwned ? 'owned' : 'ghost')
        : '';  // No ownership styling if no positions imported
      const highValueClass = isOwned && posChip.totalValue > 10000 ? 'high-value' : '';

      // Strike visualization (only for options)
      const hasStrikes = position.long_strike != null;
      const strikePos = hasStrikes ? calculateStrikePosition(position.stock_price, position.long_strike) : 50;
      const shortStrikePos = position.short_strike ? calculateStrikePosition(position.stock_price, position.short_strike) : null;

      // Telemetry-driven visuals (weighted by ownership)
      const visual = position.visual || { glow: 0.5, jitter: 0.1, thrust: 0.3, damage: 0 };
      const trend = position.trend ?? 0;
      const momentum = position.momentum ?? 0;
      const volatility = position.volatility ?? 0.5;
      const activity = position.activity ?? 0.5;
      const signalState = position.signalState || 'neutral';

      // Apply visual weight to glow intensity
      const baseGlow = Math.max(0.3, visual.glow);
      const glowIntensity = baseGlow * visualWeight * 1.5;
      const thrustLength = 20 + (visual.thrust * 30 * visualWeight);
      const damageOpacity = visual.damage * 0.5;

      const signalColors = {
        bull: 'var(--green-neon)',
        bear: 'var(--red-alert)',
        neutral: 'var(--cyan)'
      };
      const signalColor = signalColors[signalState] || signalColors.neutral;

      const card = document.createElement('div');
      card.className = `ship-card ${pnlClass} ${ownershipClass} ${highValueClass}`.trim();
      card.style.cssText = `--ship-glow: ${glowIntensity}; --ship-color: ${config.color}; --signal-color: ${signalColor}; --ownership-weight: ${visualWeight};`;
      
      if (volatility > 0.6) card.classList.add('high-volatility');
      
      // ═══════════════════════════════════════════════════════════════════
      // POSITION CHIP HTML - Only show if owned
      // ═══════════════════════════════════════════════════════════════════
      const positionChipHtml = isOwned ? `
        <div class="position-chip owned">
          <span class="position-chip-label">POS</span>
          <span class="position-chip-value">$${formatCompactValue(posChip.totalValue)}</span>
          ${posChip.hasOptions ? `<span class="position-chip-options">${posChip.optionCount}</span>` : ''}
          <div class="position-chip-bar">
            <div class="position-chip-bar-stock" style="width: ${posChip.totalValue > 0 ? (posChip.stockValue / posChip.totalValue * 100) : 0}%"></div>
            <div class="position-chip-bar-options" style="width: ${posChip.totalValue > 0 ? (posChip.optionsValue / posChip.totalValue * 100) : 0}%"></div>
          </div>
        </div>
      ` : '';
      
      // ═══════════════════════════════════════════════════════════════════
      // POSITION METERS HTML - Exposure and risk indicators
      // ═══════════════════════════════════════════════════════════════════
      const positionMetersHtml = isOwned ? `
        <div class="position-meters">
          <div class="position-meter">
            <span class="position-meter-label">EXPOSURE</span>
            <div class="position-meter-bar">
              <div class="position-meter-fill exposure" style="width: ${Math.min(100, riskMetrics.concentration * 200)}%"></div>
            </div>
          </div>
          <div class="position-meter">
            <span class="position-meter-label">RISK</span>
            <div class="position-meter-bar">
              <div class="position-meter-fill risk ${riskMetrics.riskLevel === 'high' ? 'high' : ''}" style="width: ${Math.min(100, (riskMetrics.concentration + riskMetrics.optionRatio) * 100)}%"></div>
            </div>
          </div>
        </div>
      ` : '';
      
      card.innerHTML = `
        ${positionChipHtml}
        <div class="ship-header">
          <div class="ship-callsign">
            <span class="ship-ticker" style="color: ${config.color}; text-shadow: 0 0 ${10 * glowIntensity}px ${config.color};">${position.ticker}</span>
            <span class="ship-class">${config.class}</span>
          </div>
          <div style="display: flex; align-items: center; gap: 0.5rem;">
            <span class="macd-signal-badge neutral" data-macd-signal>--</span>
            <div class="ship-pnl ${pnlClass}">
              ${displayPct >= 0 ? '+' : ''}${displayPct.toFixed(1)}%
            </div>
          </div>
        </div>
        
        <div class="ship-display">
          <!-- MACD as backdrop behind ship -->
          <div class="macd-backdrop" data-ticker="${position.ticker}">
            <div class="macd-backdrop-zero"></div>
            <canvas data-macd-canvas></canvas>
          </div>
          
          <div class="signal-indicator" style="background: ${signalColor}; box-shadow: 0 0 10px ${signalColor};"></div>
          <div class="ship-sprite-wrap" style="--ship-color: ${config.color}; z-index: 2;">
            <img class="ship-sprite-img ship-behavior" 
                 data-ticker="${position.ticker}"
                 data-ship-class="${config.class}"
                 data-pnl-pct="${displayPct}"
                 data-volatility="${volatility}"
                 data-trend="${trend}"
                 data-momentum="${momentum}"
                 data-activity="${activity}"
                 data-signal="${signalState}"
                 alt="${position.ticker} ship"
                 loading="lazy"
                 decoding="async" />
          </div>
          <div class="engine-glow" style="
            background: linear-gradient(to bottom, ${config.color}, transparent);
            height: ${thrustLength}px;
            opacity: ${0.4 + activity * 0.6};
            z-index: 3;
          "></div>
          
          <!-- Timeframe dots -->
          <div class="timeframe-dots">
            <div class="timeframe-dot" data-tf="1D" title="1 Day"></div>
            <div class="timeframe-dot" data-tf="1W" title="1 Week"></div>
            <div class="timeframe-dot active" data-tf="1M" title="1 Month"></div>
            <div class="timeframe-dot" data-tf="3M" title="3 Months"></div>
          </div>
        </div>

        <div class="behavior-badges">
          <span class="behavior-badge" data-badge="thrust" data-state="">--</span>
          <span class="behavior-badge" data-badge="stability" data-state="">--</span>
          <span class="behavior-badge" data-badge="hull" data-state="">--</span>
        </div>

        <div class="telemetry-bars">
          <div class="telem-bar-row">
            <span class="telem-bar-label">TREND</span>
            <div class="telem-bar">
              <div class="telem-bar-fill trend" style="width: ${50 + trend * 50}%;"></div>
              <div class="telem-bar-center"></div>
            </div>
          </div>
          <div class="telem-bar-row">
            <span class="telem-bar-label">MOMENTUM</span>
            <div class="telem-bar">
              <div class="telem-bar-fill momentum" style="width: ${50 + momentum * 50}%;"></div>
              <div class="telem-bar-center"></div>
            </div>
          </div>
          <div class="telem-bar-row">
            <span class="telem-bar-label">VOLATILITY</span>
            <div class="telem-bar">
              <div class="telem-bar-fill volatility" style="width: ${volatility * 100}%;"></div>
            </div>
          </div>
        </div>

        ${renderJourneyVisualization(position)}

        ${hasStrikes ? `
        <div class="strike-range">
          <span style="font-size: 0.625rem; color: var(--text-muted);">$${position.long_strike}</span>
          <div class="strike-bar">
            <div class="strike-marker" style="left: ${strikePos}%;"></div>
            ${shortStrikePos !== null ? `<div class="strike-marker current" style="left: ${shortStrikePos}%;"></div>` : ''}
          </div>
          <span style="font-size: 0.625rem; color: var(--text-muted);">${position.short_strike ? '$' + position.short_strike : '--'}</span>
        </div>
        ` : ''}

        <div class="ship-telemetry">
          <div class="telemetry-item">
            <div class="telemetry-label">PRICE</div>
            <div class="telemetry-value">$${position.stock_price.toFixed(2)}</div>
          </div>
          <div class="telemetry-item">
            <div class="telemetry-label">${hasPosition ? 'DELTA' : 'SIGNAL'}</div>
            <div class="telemetry-value">${hasPosition ? position.delta.toFixed(2) : signalState.toUpperCase()}</div>
          </div>
          <div class="telemetry-item">
            <div class="telemetry-label">${hasPosition ? 'VALUE' : 'ACTIVITY'}</div>
            <div class="telemetry-value">${hasPosition ? formatCurrency(value) : (activity * 100).toFixed(0) + '%'}</div>
          </div>
        </div>
        
        ${positionMetersHtml}
      `;

      return card;
    }

    // ═══════════════════════════════════════════════════════════════════════
    // FLEET POWER HUD - Real-time exposure overview from PositionsStore
    // ═══════════════════════════════════════════════════════════════════════

    function updateFleetPowerHUD() {
      const hud = document.getElementById('fleet-power-hud');
      if (!hud || !window.PositionsStore) return;
      
      const stats = PositionsStore.getFleetStats();
      const concentration = PositionsStore.getConcentration(3);
      
      // Update HUD class based on whether positions exist
      if (stats.hasPositions) {
        hud.classList.remove('empty');
      } else {
        hud.classList.add('empty');
      }
      
      // Update exposure
      const exposureEl = document.getElementById('hud-exposure');
      if (exposureEl) {
        exposureEl.textContent = stats.totalExposure > 0 
          ? '$' + formatCompactValue(stats.totalExposure)
          : '--';
      }
      
      // Update options ratio
      const optionsEl = document.getElementById('hud-options-ratio');
      if (optionsEl) {
        const pct = stats.optionsRatio * 100;
        optionsEl.textContent = stats.hasPositions 
          ? pct.toFixed(0) + '%'
          : '--';
        optionsEl.className = 'fleet-power-value ' + (pct > 50 ? '' : 'neutral');
      }
      
      // Update concentration (top 3)
      const concEl = document.getElementById('hud-concentration');
      if (concEl) {
        if (concentration.length > 0) {
          concEl.innerHTML = concentration.map(c => 
            `<span class="fleet-concentration-item">
              <span class="ticker">${c.ticker}</span>
              <span class="percent">${c.percent.toFixed(0)}%</span>
            </span>`
          ).join('');
        } else {
          concEl.innerHTML = '<span class="fleet-concentration-item">--</span>';
        }
      }
      
      // Update P&L
      const pnlEl = document.getElementById('hud-pnl');
      if (pnlEl) {
        if (stats.hasPositions && stats.totalPnL !== 0) {
          const sign = stats.totalPnL >= 0 ? '+' : '';
          pnlEl.textContent = sign + '$' + formatCompactValue(Math.abs(stats.totalPnL));
          pnlEl.className = 'fleet-power-value ' + (stats.totalPnL >= 0 ? 'positive' : 'negative');
        } else {
          pnlEl.textContent = '--';
          pnlEl.className = 'fleet-power-value';
        }
      }
    }

    // ═══════════════════════════════════════════════════════════════════════
    // FLEET COMMS - Diegetic risk alerts
    // ═══════════════════════════════════════════════════════════════════════

    function updateFleetComms() {
      const comms = document.getElementById('fleet-comms');
      const lines = document.getElementById('fleet-comms-lines');
      if (!comms || !lines || !window.PositionsStore) return;
      
      const stats = PositionsStore.getFleetStats();
      const concentration = PositionsStore.getConcentration(1);
      const alerts = [];
      
      // Check concentration
      if (concentration.length > 0 && concentration[0].percent > 30) {
        alerts.push({
          level: concentration[0].percent > 50 ? 'critical' : 'warning',
          text: `CONCENTRATION: <span class="${concentration[0].percent > 50 ? 'critical' : 'highlight'}">${concentration[0].percent.toFixed(0)}%</span> in <span class="highlight">${concentration[0].ticker}</span>`
        });
      }
      
      // Check options ratio
      if (stats.optionsRatio > 0.5) {
        alerts.push({
          level: stats.optionsRatio > 0.7 ? 'critical' : 'warning',
          text: `OPTIONS HEAVY: <span class="${stats.optionsRatio > 0.7 ? 'critical' : 'highlight'}">${(stats.optionsRatio * 100).toFixed(0)}%</span> derivatives exposure`
        });
      }
      
      // Check total exposure (arbitrary thresholds for demo)
      if (stats.totalExposure > 50000) {
        alerts.push({
          level: 'warning',
          text: `HIGH EXPOSURE: <span class="highlight">$${formatCompactValue(stats.totalExposure)}</span> total position size`
        });
      }
      
      // Show/hide comms panel
      if (alerts.length > 0) {
        comms.style.display = 'block';
        lines.innerHTML = alerts.map(a => `
          <div class="fleet-comm-line">
            <div class="fleet-comm-icon ${a.level}"></div>
            <span class="fleet-comm-text">${a.text}</span>
          </div>
        `).join('');
      } else {
        comms.style.display = 'none';
      }
    }

    // Listen for position changes to update HUD
    if (window.PositionsStore) {
      PositionsStore.onChange(() => {
        updateFleetPowerHUD();
        updateFleetComms();
        // Re-render fleet to update ownership states
        if (window._lastFleetData) {
          renderFleet(window._lastFleetData);
        }
      });
    }

    function renderFleet(positions) {
      // Store for re-render on position changes
      window._lastFleetData = positions;
      
      const grid = document.getElementById('fleet-grid');
      grid.innerHTML = '';
      
      // ═══════════════════════════════════════════════════════════════════
      // UPDATE FLEET POWER HUD - Read from PositionsStore
      // ═══════════════════════════════════════════════════════════════════
      updateFleetPowerHUD();
      updateFleetComms();
      
      // Filter to only show tickers that have ship profiles configured
      const configuredPositions = positions.filter(pos => TICKER_CONFIG[pos.ticker]);
      
      // Store positions for the animator to access
      window._fleetPositions = {};
      configuredPositions.forEach(pos => {
        window._fleetPositions[pos.ticker] = pos;
        grid.appendChild(renderShipCard(pos));
      });

      document.getElementById('ship-count').textContent = configuredPositions.length;
      
      // Show notice if some positions were filtered out
      const filteredCount = positions.length - configuredPositions.length;
      if (filteredCount > 0) {
        console.log(`[SpaceCapital] ${filteredCount} tickers hidden (no ship profile configured)`);
      }
      
      // Hydrate animated sprites and behavior controllers after DOM update
      function hydrateSprites() {
        if (!window.ShipAnimator) {
          return setTimeout(hydrateSprites, 100);
        }

        // 1) Hydrate GIF animations via ShipAnimator
        ShipAnimator.hydrateShipSprites((ticker) => {
          const pos = window._fleetPositions[ticker];
          if (!pos) return {};
          
          const cost = pos.entry_cost * pos.contracts * 100;
          const value = pos.current_price * pos.contracts * 100;
          const pnlPct = cost > 0 ? ((value - cost) / cost * 100) : pos.chgPct;
          
          return {
            pnlPct: pnlPct,
            volatility: pos.volatility ?? 0.5,
            trend: pos.trend ?? 0,
            momentum: pos.momentum ?? 0,
            activity: pos.activity ?? 0.5,
            signalState: pos.signalState || 'neutral',
            damage: pos.visual?.damage ?? 0
          };
        });

        // 2) Apply ShipBehavior state machine to each ship
        if (window.ShipBehavior) {
          document.querySelectorAll('.ship-sprite-img').forEach((img) => {
            const ticker = img.dataset.ticker;
            const pos = window._fleetPositions?.[ticker];
            if (!pos) return;

            // Get ship class from TICKER_CONFIG
            const cfg = (window.TICKER_CONFIG && window.TICKER_CONFIG[ticker]) || {};
            
            // Create behavior controller once per image
            if (!img._behaviorController) {
              img._behaviorController = ShipBehavior.create(img, {
                ticker,
                shipClass: cfg.class || 'Ship'
              });
            }

            // Calculate derived stats
            // Check PositionManager first for imported P&L data
            let pnlPct;
            let hull;
            const pmStats = window.PositionManager?.getBehaviorStats(ticker);
            
            if (pmStats && pmStats.totalPL !== 0) {
              // Use PositionManager data (from CSV import or manual entry)
              pnlPct = pmStats.pnlPercent;
              hull = pmStats.hull;
            } else {
              // Fall back to calculated P&L from telemetry
              const cost = pos.entry_cost * pos.contracts * 100;
              const value = pos.current_price * pos.contracts * 100;
              pnlPct = cost > 0 ? ((value - cost) / cost * 100) : pos.chgPct;
              hull = Math.max(0, Math.min(100, 100 - ((pos.visual?.damage ?? 0) * 100)));
            }
            
            // Map telemetry to behavior inputs
            const fuel = Math.max(0, Math.min(100, (pos.activity ?? 0.5) * 100));
            const vol = pos.volatility ?? 0.02;

            // Update behavior controller
            if (img._behaviorController) {
              img._behaviorController.updateStats({
                pnlPercent: pnlPct,
                volatility: vol,
                hull,
                fuel
              });
            }

            // 3) Update behavior badges on the card
            const card = img.closest('.ship-card');
            if (card) {
              const thrustBadge = card.querySelector('[data-badge="thrust"]');
              const stabilityBadge = card.querySelector('[data-badge="stability"]');
              const hullBadge = card.querySelector('[data-badge="hull"]');

              if (thrustBadge) {
                const state = pnlPct >= 5 ? 'THRUST++' : pnlPct > 0 ? 'THRUST+' : pnlPct > -5 ? 'DRIFT' : 'FAIL';
                thrustBadge.textContent = state;
                thrustBadge.dataset.state = state;
              }
              if (stabilityBadge) {
                const state = vol >= 0.08 ? 'EXTREME' : vol >= 0.05 ? 'HIGH' : vol >= 0.03 ? 'ELEV' : 'STABLE';
                stabilityBadge.textContent = state;
                stabilityBadge.dataset.state = state;
              }
              if (hullBadge) {
                const state = hull >= 80 ? 'HULL OK' : hull >= 50 ? 'STRESS' : hull >= 25 ? 'CRIT' : 'HULL!';
                hullBadge.textContent = state;
                hullBadge.dataset.state = state;
              }
            }
          });
        }
      }
      
      requestAnimationFrame(hydrateSprites);
      
      // Render MACD mini-charts for each ship card
      renderMACDMiniCharts();
    }

    // ═══════════════════════════════════════════════════════════════════════
    // MACD MINI-CHARTS - Render momentum indicators on ship cards
    // ═══════════════════════════════════════════════════════════════════════

    const macdChartInstances = new Map();

    async function renderMACDMiniCharts() {
      // Check if Chart.js is loaded
      if (!window.Chart) {
        console.log('[MACD] Waiting for Chart.js...');
        return setTimeout(renderMACDMiniCharts, 200);
      }

      // Find MACD backdrops (now inside ship-display)
      const containers = document.querySelectorAll('.macd-backdrop[data-ticker]');
      
      for (const container of containers) {
        const ticker = container.dataset.ticker;
        if (!ticker) continue;

        // Find signal badge in the card header (now separate from backdrop)
        const card = container.closest('.ship-card');
        const signalBadge = card?.querySelector('[data-macd-signal]');
        
        // Attach badge to container for renderMACDChart to find
        if (signalBadge) {
          container._signalBadge = signalBadge;
        }

        // Try to load indicator data, fall back to synthetic
        let macdData = null;
        
        try {
          if (window.IndicatorLoader) {
            const data = await IndicatorLoader.getRecentBars(ticker, 24);
            if (data && data.length > 0 && data[0].macd != null) {
              macdData = data.map(d => ({
                macd: d.macd,
                signal: d.signalLine,
                histogram: d.histogram
              })).filter(d => d.macd != null && d.signal != null);
            }
          }
        } catch (err) {
          console.log(`[MACD] No indicator data for ${ticker}, using synthetic`);
        }

        // Generate synthetic MACD from position telemetry if no real data
        if (!macdData || macdData.length < 3) {
          const pos = window._fleetPositions?.[ticker];
          macdData = generateSyntheticMACD(pos);
        }

        renderMACDChart(container, ticker, macdData);
      }
    }

    /**
     * Generate synthetic MACD data from position telemetry
     * Creates believable MACD curves from momentum/trend values
     */
    function generateSyntheticMACD(position) {
      const points = 24;
      const data = [];
      
      // Base values from position or defaults
      const momentum = position?.momentum ?? 0;
      const trend = position?.trend ?? 0;
      const volatility = position?.volatility ?? 0.5;
      
      // Generate a sine-wave-ish MACD with some noise
      for (let i = 0; i < points; i++) {
        const t = i / points;
        
        // MACD line oscillates based on momentum
        const macdBase = Math.sin(t * Math.PI * 2 + momentum * 3) * volatility * 2;
        const macdNoise = (Math.random() - 0.5) * volatility * 0.5;
        const macd = macdBase + macdNoise + trend * 0.5;
        
        // Signal line is smoothed MACD (lagging)
        const signalLag = Math.sin((t - 0.1) * Math.PI * 2 + momentum * 3) * volatility * 2;
        const signal = signalLag + trend * 0.4;
        
        data.push({
          macd: macd,
          signal: signal,
          histogram: macd - signal
        });
      }
      
      return data;
    }

    function renderMACDChart(container, ticker, macdData) {
      const canvas = container.querySelector('[data-macd-canvas]');
      // Signal badge may be attached by parent function or be inside container
      const signalBadge = container._signalBadge || container.querySelector('[data-macd-signal]');
      if (!canvas) return;

      // Destroy previous chart instance
      if (macdChartInstances.has(ticker)) {
        macdChartInstances.get(ticker).destroy();
      }

      if (!macdData || macdData.length < 3) {
        renderMACDPlaceholder(container);
        return;
      }

      // Get ship telemetry for VHS degradation effects
      const pos = window._fleetPositions?.[ticker];
      const volatility = pos?.volatility ?? 0.5;
      const thrust = pos?.visual?.thrust ?? 0.3;
      
      // === VHS DEGRADATION EFFECTS ===
      // Let the watercolor engine "ruin clarity"
      const ctx = canvas.getContext('2d');
      
      // Apply VHS filter based on volatility - more volatile = more degraded
      const blurAmount = 0.4 + volatility * 0.8;
      const contrastAmount = 1.1 + volatility * 0.1;
      const saturateAmount = 1.2 + thrust * 0.3;
      
      // Store filter for Chart.js plugin
      canvas._vhsFilter = `blur(${blurAmount}px) contrast(${contrastAmount}) saturate(${saturateAmount})`;
      canvas._vhsAlpha = 0.35 + volatility * 0.35; // More volatile = more ghostly
      
      // Ship influence for coupling effect
      canvas._shipInfluence = thrust * 0.4 + volatility * 0.6;

      // Determine signal state
      const lastMacd = macdData[macdData.length - 1];
      let signalState = 'neutral';
      let signalText = '--';

      if (lastMacd.macd > lastMacd.signal + 0.1) {
        signalState = 'bullish';
        signalText = '+ POS';
      } else if (lastMacd.macd < lastMacd.signal - 0.1) {
        signalState = 'bearish';
        signalText = '- NEG';
      }

      // Check for recent crossover
      const crossovers = detectSimpleCrossovers(macdData);
      if (crossovers.length > 0) {
        const last = crossovers[crossovers.length - 1];
        if (last.index >= macdData.length - 5) {
          signalState = last.type;
          signalText = last.type === 'bullish' ? '▲ BULL' : '▼ BEAR';
        }
      }

      if (signalBadge) {
        signalBadge.textContent = signalText;
        signalBadge.className = `macd-signal-badge ${signalState}`;
      }

      // Create chart config with VHS plugin
      const config = createSimpleMACDConfig(macdData);
      
      // Add VHS degradation plugin
      config.plugins = config.plugins || [];
      config.plugins.push({
        id: 'vhsDegradation',
        beforeDraw: (chart) => {
          const ctx = chart.ctx;
          const influence = canvas._shipInfluence || 0.5;
          const time = performance.now();
          
          // Ship ↔ MACD coupling: chart subtly warps around ship
          ctx.save();
          ctx.translate(
            Math.sin(time * 0.002) * influence * 1.5,
            Math.cos(time * 0.0015) * influence * 1.5
          );
        },
        afterDraw: (chart) => {
          const ctx = chart.ctx;
          ctx.restore();
          
          // Apply VHS ghosting - don't fully clear
          ctx.globalAlpha = canvas._vhsAlpha || 0.5;
          ctx.filter = canvas._vhsFilter || 'none';
        }
      });

      const chart = new Chart(ctx, config);
      macdChartInstances.set(ticker, chart);
      
      // Start subtle animation loop for ship coupling
      if (!canvas._animating) {
        canvas._animating = true;
        const animate = () => {
          if (!macdChartInstances.has(ticker)) {
            canvas._animating = false;
            return;
          }
          // Only update if visible and not too frequent
          if (document.visibilityState === 'visible') {
            chart.update('none');
          }
          setTimeout(() => requestAnimationFrame(animate), 100); // ~10fps for subtle effect
        };
        requestAnimationFrame(animate);
      }
    }

    function renderMACDPlaceholder(container) {
      const signalBadge = container._signalBadge || container.querySelector('[data-macd-signal]');
      if (signalBadge) {
        signalBadge.textContent = 'N/A';
        signalBadge.className = 'macd-signal-badge neutral';
      }
    }

    function detectSimpleCrossovers(macdData) {
      const crossovers = [];
      for (let i = 1; i < macdData.length; i++) {
        const prevDiff = macdData[i-1].macd - macdData[i-1].signal;
        const currDiff = macdData[i].macd - macdData[i].signal;
        
        if (prevDiff <= 0 && currDiff > 0) {
          crossovers.push({ index: i, type: 'bullish' });
        } else if (prevDiff >= 0 && currDiff < 0) {
          crossovers.push({ index: i, type: 'bearish' });
        }
      }
      return crossovers;
    }

    function createSimpleMACDConfig(macdData) {
      const macdLine = macdData.map(d => d.macd);
      const signalLine = macdData.map(d => d.signal);
      const histogram = macdData.map(d => d.histogram ?? (d.macd - d.signal));
      
      const allVals = [...macdLine, ...signalLine].filter(v => v != null);
      const absMax = Math.max(...allVals.map(Math.abs), 0.01);

      return {
        type: 'line',
        data: {
          labels: macdData.map((_, i) => i),
          datasets: [
            {
              label: 'MACD',
              data: macdLine,
              borderColor: '#FF2975',
              borderWidth: 1.5,
              pointRadius: 0,
              tension: 0.3,
              fill: false
            },
            {
              label: 'Signal',
              data: signalLine,
              borderColor: '#00FFFF',
              borderWidth: 1,
              pointRadius: 0,
              tension: 0.3,
              fill: false,
              borderDash: [2, 2]
            },
            {
              type: 'bar',
              label: 'Hist',
              data: histogram,
              backgroundColor: histogram.map(h => h >= 0 ? 'rgba(0, 255, 255, 0.4)' : 'rgba(255, 41, 117, 0.4)'),
              borderWidth: 0,
              barPercentage: 0.8
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
          scales: {
            x: { display: false },
            y: { display: false, min: -absMax * 1.1, max: absMax * 1.1 }
          },
          animation: false
        }
      };
    }

    // Global function to update behavior states (called when positions change)
    function updateShipBehaviors() {
      if (!window.ShipBehavior) return;
      
      document.querySelectorAll('.ship-sprite-img').forEach((img) => {
        const ticker = img.dataset.ticker;
        const pos = window._fleetPositions?.[ticker];
        if (!pos) return;

        // Check PositionManager for imported P&L data
        let pnlPct;
        let hull;
        const pmStats = window.PositionManager?.getBehaviorStats(ticker);
        
        if (pmStats && pmStats.totalPL !== 0) {
          pnlPct = pmStats.pnlPercent;
          hull = pmStats.hull;
        } else {
          const cost = pos.entry_cost * pos.contracts * 100;
          const value = pos.current_price * pos.contracts * 100;
          pnlPct = cost > 0 ? ((value - cost) / cost * 100) : pos.chgPct;
          hull = Math.max(0, Math.min(100, 100 - ((pos.visual?.damage ?? 0) * 100)));
        }
        
        const fuel = Math.max(0, Math.min(100, (pos.activity ?? 0.5) * 100));
        const vol = pos.volatility ?? 0.02;

        // Update behavior controller
        if (img._behaviorController) {
          img._behaviorController.updateStats({
            pnlPercent: pnlPct,
            volatility: vol,
            hull,
            fuel
          });
        }

        // Update behavior badges
        const card = img.closest('.ship-card');
        if (card) {
          const thrustBadge = card.querySelector('[data-badge="thrust"]');
          const stabilityBadge = card.querySelector('[data-badge="stability"]');
          const hullBadge = card.querySelector('[data-badge="hull"]');

          if (thrustBadge) {
            const state = pnlPct >= 5 ? 'THRUST++' : pnlPct > 0 ? 'THRUST+' : pnlPct > -5 ? 'DRIFT' : 'FAIL';
            thrustBadge.textContent = state;
            thrustBadge.dataset.state = state;
          }
          if (stabilityBadge) {
            const state = vol >= 0.08 ? 'EXTREME' : vol >= 0.05 ? 'HIGH' : vol >= 0.03 ? 'ELEV' : 'STABLE';
            stabilityBadge.textContent = state;
            stabilityBadge.dataset.state = state;
          }
          if (hullBadge) {
            const state = hull >= 80 ? 'HULL OK' : hull >= 50 ? 'STRESS' : hull >= 25 ? 'CRIT' : 'HULL!';
            hullBadge.textContent = state;
            hullBadge.dataset.state = state;
          }
        }
      });
    }

    function renderThemes(positions) {
      const themes = {};
      let maxValue = 0;

      // Theme abbreviations (no emojis)
      const THEME_ABBR = {
        'Space': 'SPC',
        'Air Mobility': 'AIR',
        'Defense': 'DEF',
        'Tech': 'TCH',
        'Meme': 'MEM',
        'Benchmark': 'BNC'
      };

      positions.forEach(pos => {
        const config = TICKER_CONFIG[pos.ticker] || DEFAULT_CONFIG;
        const value = pos.entry_cost * pos.contracts * 100;
        
        if (!themes[config.theme]) {
          themes[config.theme] = { abbr: THEME_ABBR[config.theme] || config.theme.slice(0,3).toUpperCase(), value: 0 };
        }
        themes[config.theme].value += value;
        maxValue = Math.max(maxValue, themes[config.theme].value);
      });

      const grid = document.getElementById('theme-grid');
      grid.innerHTML = Object.entries(themes)
        .sort((a, b) => b[1].value - a[1].value)
        .map(([name, data]) => `
          <div class="theme-row">
            <span class="theme-icon" style="font-size: 0.6rem; width: 28px;">${data.abbr}</span>
            <span class="theme-name">${name}</span>
            <span class="theme-value">${formatCurrency(data.value)}</span>
            <div class="theme-bar">
              <div class="theme-bar-fill" style="width: ${(data.value / maxValue * 100)}%;"></div>
            </div>
          </div>
        `).join('');
    }

    function renderCatalysts(catalysts) {
      const list = document.getElementById('catalyst-list');
      list.innerHTML = catalysts.slice(0, 5).map(cat => {
        const config = TICKER_CONFIG[cat.ticker] || DEFAULT_CONFIG;
        return `
          <div class="catalyst-item ${cat.impact === 'HIGH' ? 'high-impact' : ''}">
            <div class="catalyst-date">${cat.date}</div>
            <div class="catalyst-info">
              <div class="catalyst-ticker" style="color: ${config.color};">${cat.ticker}</div>
              <div class="catalyst-event">${cat.event}</div>
            </div>
            <span class="catalyst-impact ${cat.impact.toLowerCase()}">${cat.impact}</span>
          </div>
        `;
      }).join('');
    }

    function renderStats(data) {
      const positions = data.positions || [];
      
      let totalCost = 0;
      let totalValue = 0;
      let totalDelta = 0;

      positions.forEach(pos => {
        const cost = pos.entry_cost * pos.contracts * 100;
        const value = pos.current_price * pos.contracts * 100;
        totalCost += cost;
        totalValue += value;
        totalDelta += pos.delta * pos.contracts;
      });

      const totalPnl = totalValue - totalCost;
      
      document.getElementById('total-value').textContent = formatCurrency(totalValue);
      
      const pnlEl = document.getElementById('total-pnl');
      pnlEl.textContent = formatCurrency(totalPnl);
      pnlEl.className = 'stat-value ' + (totalPnl >= 0 ? 'positive' : 'negative');
      
      document.getElementById('total-delta').textContent = totalDelta.toFixed(2);
      document.getElementById('days-to-expiry').textContent = data.summary?.days_to_expiry || calculateDaysToExpiry(positions);
      document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
    }

    function calculateDaysToExpiry(positions) {
      if (!positions.length) return 0;
      const expiry = new Date(positions[0].expiry);
      const today = new Date();
      return Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
    }

    // =========================================================================
    // TICKER FOCUS - Accept ?ticker=RKLB from other pages
    // =========================================================================
    
    function focusTickerFromUrl() {
      const ticker = new URLSearchParams(window.location.search).get('ticker');
      if (!ticker) return;

      // Find the ship card with this ticker
      const img = document.querySelector(`.ship-sprite-img[data-ticker="${ticker.toUpperCase()}"]`);
      const card = img?.closest('.ship-card');
      if (!card) {
        console.log('[SpaceCapital] Ticker from URL not found in fleet:', ticker);
        return;
      }

      // Add focused class and scroll into view
      card.classList.add('focused');
      setTimeout(() => {
        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }, 100);

      // Remove focus after animation
      setTimeout(() => {
        card.classList.remove('focused');
      }, 5000);

      console.log('[SpaceCapital] Focused on ticker from URL:', ticker);
    }

    // =========================================================================
    // DATA LOADING - Supports multiple sources
    // =========================================================================
    
    // Data paths - relative to html/ subfolder
    const DATA_PATHS = {
      fleet: '../data/telemetry/fleet.json',
      positions: '../data/options_summaries/positions.json',
      catalysts: '../data/options_summaries/catalysts.json',
      manifest: '../data/telemetry/manifest.json',
      stats: '../data/stats.json'
    };

    // Load historical stats data (52w range, returns over time)
    async function loadStats() {
      try {
        const response = await fetch(DATA_PATHS.stats);
        if (response.ok) {
          const data = await response.json();
          console.log('[OK] Loaded historical stats:', Object.keys(data.stats || {}).length, 'tickers');
          return data.stats || {};
        }
      } catch (e) {
        console.log('Stats file not found, historical data unavailable');
      }
      return {};
    }

    // Load telemetry-enriched fleet data
    async function loadFleetTelemetry() {
      try {
        const response = await fetch(DATA_PATHS.fleet);
        if (response.ok) {
          const data = await response.json();
          console.log('[OK] Loaded fleet telemetry:', data.ships?.length, 'ships');
          return data;
        }
      } catch (e) {
        console.log('Fleet telemetry not found, using fallback');
      }
      return null;
    }

    // Load options position data (for P&L calculations)
    async function loadPositions() {
      try {
        const response = await fetch(DATA_PATHS.positions);
        if (response.ok) {
          const data = await response.json();
          console.log('[OK] Loaded positions:', data.positions?.length);
          return data;
        }
      } catch (e) {
        console.log('Positions file not found');
      }
      return null;
    }

    // Main data loader - fleet.json is primary, positions optional
    async function loadData() {
      const [fleet, positions, stats] = await Promise.all([
        loadFleetTelemetry(),
        loadPositions(),
        loadStats()
      ]);

      // If we have fleet telemetry, use it as the base
      if (fleet?.ships) {
        const positionMap = {};
        if (positions?.positions) {
          positions.positions.forEach(p => { positionMap[p.ticker] = p; });
        }

        // Merge fleet telemetry with any position data AND historical stats
        const enrichedShips = fleet.ships.map(ship => {
          const pos = positionMap[ship.ticker] || {};
          const hist = stats[ship.ticker] || {};
          
          return {
            ticker: ship.ticker,
            // Telemetry data
            stock_price: ship.price,
            chgPct: ship.chgPct,
            trend: ship.trend,
            momentum: ship.momentum,
            volatility: ship.volatility,
            activity: ship.activity,
            signalState: ship.signalState,
            visual: ship.visual,
            // Position data (if available)
            structure: pos.structure || 'Equity',
            long_strike: pos.long_strike || null,
            short_strike: pos.short_strike || null,
            expiry: pos.expiry || null,
            entry_cost: pos.entry_cost || 0,
            current_price: pos.current_price || ship.price,
            delta: pos.delta || ship.trend,
            contracts: pos.contracts || 0,
            // Historical stats (for journey visualization)
            history: {
              high_52w: hist.high_52w || ship.price * 1.2,
              low_52w: hist.low_52w || ship.price * 0.8,
              return_1d: hist.return_1d || ship.chgPct || 0,
              return_1w: hist.return_1w || 0,
              return_1m: hist.return_1m || 0,
              return_3m: hist.return_3m || 0,
              return_6m: hist.return_6m || 0,
              return_1y: hist.return_1y || 0,
              daily_count: hist.daily_count || 0
            }
          };
        });

        return {
          positions: enrichedShips,
          catalysts: positions?.catalysts || FALLBACK_DATA.catalysts,
          asOf: fleet.asOf
        };
      }

      // Fallback to embedded data
      console.log('Using embedded fallback data');
      return FALLBACK_DATA;
    }

    // Embedded fallback data (works without any external files)
    const FALLBACK_DATA = {
      "positions": [
        { "ticker": "RKLB", "structure": "Naked LEAP", "long_strike": 75, "short_strike": null, "expiry": "2027-01-15", "entry_cost": 24.14, "current_price": 24.14, "delta": 0.68, "contracts": 1, "stock_price": 75.99, "entry_stock": 75.99, "trend": 0.6, "momentum": 0.4, "volatility": 0.5, "activity": 0.7, "signalState": "bull", "visual": { "glow": 0.7, "jitter": 0.1, "thrust": 0.5, "damage": 0 }, "history": { "high_52w": 77.46, "low_52w": 16.30, "return_1d": 2.16, "return_1w": -6.5, "return_1m": 74.66, "return_3m": 43.23, "return_1y": 177.9, "daily_count": 1281 } },
        { "ticker": "LUNR", "structure": "Naked LEAP", "long_strike": 17.5, "short_strike": null, "expiry": "2027-01-15", "entry_cost": 6.69, "current_price": 6.69, "delta": 0.7, "contracts": 1, "stock_price": 17.88, "entry_stock": 17.88, "trend": 0.3, "momentum": 0.2, "volatility": 0.7, "activity": 0.5, "signalState": "neutral", "visual": { "glow": 0.5, "jitter": 0.2, "thrust": 0.3, "damage": 0.1 }, "history": { "high_52w": 23.49, "low_52w": 6.62, "return_1d": 5.32, "return_1w": 2.03, "return_1m": 81.87, "return_3m": 54.79, "return_1y": -6.48, "daily_count": 920 } },
        { "ticker": "ASTS", "structure": "Bull Spread", "long_strike": 80, "short_strike": 120, "expiry": "2027-01-15", "entry_cost": 20.0, "current_price": 20.0, "delta": 0.42, "contracts": 1, "stock_price": 83.47, "entry_stock": 83.47, "trend": 0.5, "momentum": 0.3, "volatility": 0.6, "activity": 0.6, "signalState": "bull", "visual": { "glow": 0.6, "jitter": 0.15, "thrust": 0.4, "damage": 0 }, "history": { "high_52w": 96.58, "low_52w": 17.88, "return_1d": 15.08, "return_1w": 5.14, "return_1m": 45.6, "return_3m": 25.69, "return_1y": 279.86, "daily_count": 267 } },
        { "ticker": "ACHR", "structure": "Naked LEAP", "long_strike": 7.5, "short_strike": null, "expiry": "2027-01-15", "entry_cost": 3.0, "current_price": 3.0, "delta": 0.72, "contracts": 1, "stock_price": 8.13, "entry_stock": 8.13, "trend": 0.7, "momentum": 0.5, "volatility": 0.4, "activity": 0.8, "signalState": "bull", "visual": { "glow": 0.8, "jitter": 0.1, "thrust": 0.6, "damage": 0 }, "history": { "high_52w": 13.48, "low_52w": 6.14, "return_1d": 4.64, "return_1w": -4.19, "return_1m": 3.33, "return_3m": -22.06, "return_1y": -23.98, "daily_count": 801 } },
        { "ticker": "JOBY", "structure": "Bull Spread", "long_strike": 12.5, "short_strike": 20, "expiry": "2027-01-15", "entry_cost": 3.5, "current_price": 3.5, "delta": 0.43, "contracts": 1, "stock_price": 14.36, "entry_stock": 14.36, "trend": 0.4, "momentum": 0.2, "volatility": 0.5, "activity": 0.5, "signalState": "neutral", "visual": { "glow": 0.5, "jitter": 0.15, "thrust": 0.35, "damage": 0.05 }, "history": { "high_52w": 19.98, "low_52w": 5.34, "return_1d": 4.97, "return_1w": -3.33, "return_1m": 1.21, "return_3m": -18.98, "return_1y": 63.18, "daily_count": 374 } },
        { "ticker": "GME", "structure": "Bull Spread", "long_strike": 20, "short_strike": 35, "expiry": "2027-01-15", "entry_cost": 4.5, "current_price": 4.5, "delta": 0.6, "contracts": 1, "stock_price": 20.62, "entry_stock": 20.62, "trend": -0.1, "momentum": -0.2, "volatility": 0.9, "activity": 0.4, "signalState": "neutral", "visual": { "glow": 0.4, "jitter": 0.3, "thrust": 0.2, "damage": 0.2 }, "history": { "high_52w": 34.87, "low_52w": 20.04, "return_1d": 2.85, "return_1w": -4.01, "return_1m": -9.8, "return_3m": -24.14, "return_1y": -35.47, "daily_count": 265 } },
        { "ticker": "BKSY", "structure": "Naked LEAP", "long_strike": 20, "short_strike": null, "expiry": "2027-01-15", "entry_cost": 7.56, "current_price": 7.56, "delta": 0.7, "contracts": 1, "stock_price": 20.82, "entry_stock": 20.82, "trend": 0.3, "momentum": 0.1, "volatility": 0.5, "activity": 0.4, "signalState": "neutral", "visual": { "glow": 0.45, "jitter": 0.12, "thrust": 0.25, "damage": 0.1 }, "history": { "high_52w": 31.58, "low_52w": 6.62, "return_1d": 10.14, "return_1w": -1.64, "return_1m": 22.3, "return_3m": -14.73, "return_1y": 87.67, "daily_count": 267 } },
        { "ticker": "RDW", "structure": "Bull Spread", "long_strike": 12.5, "short_strike": 20, "expiry": "2027-01-15", "entry_cost": 3.5, "current_price": 3.5, "delta": 0.55, "contracts": 1, "stock_price": 9.07, "entry_stock": 9.07, "trend": 0.2, "momentum": 0.1, "volatility": 0.4, "activity": 0.3, "signalState": "neutral", "visual": { "glow": 0.4, "jitter": 0.1, "thrust": 0.2, "damage": 0.15 }, "history": { "high_52w": 25.88, "low_52w": 5.08, "return_1d": 19.99, "return_1w": 15.28, "return_1m": 71.05, "return_3m": -12.56, "return_1y": -48.98, "daily_count": 266 } },
        { "ticker": "PL", "structure": "Bull Spread", "long_strike": 4, "short_strike": 6, "expiry": "2027-01-15", "entry_cost": 0.65, "current_price": 0.65, "delta": 0.43, "contracts": 1, "stock_price": 20.4, "entry_stock": 20.4, "trend": -0.2, "momentum": -0.1, "volatility": 0.6, "activity": 0.2, "signalState": "bear", "visual": { "glow": 0.3, "jitter": 0.2, "thrust": 0.1, "damage": 0.3 }, "history": { "high_52w": 20.8, "low_52w": 2.95, "return_1d": 3.34, "return_1w": 0.23, "return_1m": 72.55, "return_3m": 36.7, "return_1y": 382.35, "daily_count": 267 } },
        { "ticker": "EVEX", "structure": "Bull Spread", "long_strike": 7.5, "short_strike": 12.5, "expiry": "2027-01-15", "entry_cost": 2.0, "current_price": 2.0, "delta": 0.45, "contracts": 1, "stock_price": 4.18, "entry_stock": 4.18, "trend": 0.1, "momentum": 0.0, "volatility": 0.5, "activity": 0.3, "signalState": "neutral", "visual": { "glow": 0.35, "jitter": 0.15, "thrust": 0.15, "damage": 0.2 }, "history": { "high_52w": 7.5, "low_52w": 3.08, "return_1d": 3.11, "return_1w": -6.44, "return_1m": -9.75, "return_3m": -0.9, "return_1y": -24.15, "daily_count": 380 } }
      ],
      "catalysts": [
        { "date": "2026-02-15", "ticker": "LUNR", "event": "IM-2 Lunar Mission", "impact": "HIGH", "status": "UPCOMING" },
        { "date": "2026-Q1", "ticker": "ACHR", "event": "FAA Certification", "impact": "HIGH", "status": "UPCOMING" },
        { "date": "2026-Q1", "ticker": "JOBY", "event": "FAA Certification", "impact": "HIGH", "status": "UPCOMING" },
        { "date": "2026-Q2", "ticker": "ASTS", "event": "Commercial Launch", "impact": "HIGH", "status": "UPCOMING" },
        { "date": "2026-Q2", "ticker": "RKLB", "event": "Neutron Update", "impact": "MEDIUM", "status": "UPCOMING" },
        { "date": "2026-03-31", "ticker": "GME", "event": "Q4 Earnings", "impact": "MEDIUM", "status": "UPCOMING" }
      ]
    };

    // =========================================================================
    // INITIALIZATION
    // =========================================================================

    async function init() {
      // Initialize watercolor ambient lighting
      if (window.HangarWatercolor) {
        HangarWatercolor.setupPage('fleet');
      }
      
      // Use new Telemetry Lock-In transition if available
      if (window.TelemetryLockIn) {
        await TelemetryLockIn.run({
          onDataReady: async () => {
            // Load and render data during lock-in
            const data = await loadData();
            renderFleet(data.positions);
            renderThemes(data.positions);
            renderCatalysts(data.catalysts);
            renderStats(data);
            
            // Apply semantic state based on overall portfolio
            if (window.VisualTiers) {
              const avgTrend = data.positions.reduce((sum, p) => sum + (p.trend || 0), 0) / data.positions.length;
              const avgVolatility = data.positions.reduce((sum, p) => sum + (p.volatility || 0), 0) / data.positions.length;
              const tiers = VisualTiers.telemetryToTiers({
                trend: avgTrend,
                momentum: avgTrend,
                volatility: avgVolatility,
                activity: 0.5
              });
              const state = VisualTiers.getSemanticState(tiers);
              VisualTiers.applySemanticState(state);
            }
          },
          telemetryData: {
            signal: 'LOCKED',
            status: 'FLEET READY'
          }
        });
      } else {
        // Fallback: just load data directly
        const data = await loadData();
        renderFleet(data.positions);
        renderThemes(data.positions);
        renderCatalysts(data.catalysts);
        renderStats(data);
      }

      // Focus ticker from URL parameter (e.g., ?ticker=RKLB from derivatives)
      focusTickerFromUrl();

      // Ship card click → open HANGAR (ship detail hub)
      document.getElementById('fleet-grid').addEventListener('click', (e) => {
        const card = e.target.closest('.ship-card');
        if (!card) return;
        
        const img = card.querySelector('.ship-sprite-img');
        if (!img) return;
        
        const ticker = img.dataset.ticker;
        if (!ticker) return;

        // COMMIT TO STORE FIRST (authoritative state)
        if (window.Store) {
          Store.set({
            activeTicker: ticker,
            activeShip: window._fleetPositions?.[ticker] || null,
            activeMission: null
          });
          console.log('[Fleet] Committed ticker to Store:', ticker);
        }

        // Navigate to HANGAR - the ship detail hub
        window.location.href = `hangar.html?ship=${encodeURIComponent(ticker)}`;
      });

      // Position Manager button
      document.getElementById('openPositionsBtn')?.addEventListener('click', () => {
        if (window.PositionManagerUI) {
          PositionManagerUI.open();
        }
      });

      // Pilot button - go to pilot select
      document.getElementById('pilotBtn')?.addEventListener('click', () => {
        window.location.href = 'pilot-select.html';
      });

      // Hangar button - go to ship select
      document.getElementById('openHangarBtn')?.addEventListener('click', () => {
        window.location.href = 'ship-select.html';
      });

      // Registry terminal button
      document.getElementById('openRegistryBtn')?.addEventListener('click', () => {
        openRegistryTerminal();
      });

      // Derivatives button - go to derivatives console (preserves active ticker)
      document.getElementById('openDerivativesBtn')?.addEventListener('click', () => {
        const ticker = window.Store?.get('activeTicker') || 'RKLB';
        window.location.href = `derivatives.html?ticker=${ticker}`;
      });

      // Update pilot display in header
      function updatePilotDisplay() {
        if (!window.PlayerManager) return;
        
        const pilot = PlayerManager.getActive();
        if (pilot) {
          document.getElementById('pilotCallsign').textContent = pilot.callsign;
          const avatarContainer = document.getElementById('pilotAvatarMini');
          const avatarPath = PlayerManager.getAvatarPath(pilot.avatar);
          avatarContainer.innerHTML = `<img src="${avatarPath}" alt="${pilot.name}">`;
        }
      }
      updatePilotDisplay();

      // Listen for profile changes
      window.PlayerManager?.onChange((event, data) => {
        if (event === 'switched') {
          console.log('[SpaceCapital] Profile switched, reloading positions...');
          PositionManager.switchProfile();
          updatePilotDisplay();
        }
      });

      // Re-hydrate sprites when position data changes
      window.PositionManager?.onChange(() => {
        console.log('[SpaceCapital] Position data changed, updating behaviors...');
        updateShipBehaviors();
      });

      // Set up polling for updates
      setInterval(async () => {
        const freshData = await loadData();
        renderFleet(freshData.positions);
        renderStats(freshData);
      }, 30000);
    }

    // Start
    init();
  </script>
  
    </div><!-- /.ui-layer -->
  </div><!-- /.app-shell -->

  <!-- ═══════════════════════════════════════════════════════════════════════
       MODULE VIEWER OVERLAY
       Iframe-based viewer for orphan pages without CSS conflicts
       ═══════════════════════════════════════════════════════════════════════ -->
  <div id="moduleViewer" class="moduleViewer" aria-hidden="true">
    <div class="moduleViewer__panel" role="dialog" aria-modal="true" aria-label="Module Viewer">
      <div class="moduleViewer__bar">
        <div class="moduleViewer__title">MODULE VIEWER</div>
        <select id="moduleViewerSelect" class="moduleViewer__select" aria-label="Choose module"></select>
        <button id="moduleViewerClose" class="moduleViewer__btn moduleViewer__btn--close">[X] CLOSE</button>
      </div>
      <iframe id="moduleViewerFrame" class="moduleViewer__frame" title="Module content"></iframe>
    </div>
  </div>

  <!-- ═══════════════════════════════════════════════════════════════════════
       BUILD: 2026-01-08 v2 — Store coherence + Chart fix + Cache-bust
       ═══════════════════════════════════════════════════════════════════════ -->

  <!-- UI Overhaul Modules -->
  <!-- Core State Store -->
  <script src="../js/core/store.js?v=20260108"></script>
  
  <!-- Watercolor Pigment Engine (ambient lighting) -->
  <script src="../js/lib/watercolor/watercolor-engine.js?v=20260108"></script>
  <script src="../js/ui/hangar-watercolor.js?v=20260108"></script>
  
  <script src="../js/ui/visual-tiers.js?v=20260108"></script>
  <script src="../js/ui/telemetry-lockin.js?v=20260108"></script>

  <!-- Chart.js for MACD mini-charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <!-- Chart Utilities - Robust data processing -->
  <script src="../js/data/chart-utils.js?v=20260108"></script>
  
  <!-- Indicator Loader - CSV data access -->
  <script src="../js/data/indicator-loader.js?v=20260108"></script>

  <!-- Ship Behavior Engine - State machine for reactive sprites -->
  <script src="../js/ships/ship-behavior.js?v=20260108"></script>

  <!-- Trade Loader - Canonical trade data for Guest pilot -->
  <script src="../js/data/load-trades.js?v=20260108"></script>

  <!-- Player Manager - Pilot profiles -->
  <script src="../js/data/player-manager.js?v=20260108"></script>

  <!-- Position Manager - P&L and cost basis data -->
  <script src="../js/data/position-manager.js?v=20260108"></script>
  <script src="../js/ui/position-manager-ui.js?v=20260108"></script>

  <!-- Positions Store - Fleet-wide position integration -->
  <script src="../js/data/positions-store.js?v=20260108"></script>

  <!-- Ship Animator - Telemetry-driven sprite animations -->
  <script src="../js/ui/ship-animator.js?v=20260108"></script>

  <!-- Module Viewer Script -->
  <script src="../js/ui/module-viewer.js?v=20260108"></script>

  <!-- Registry Terminal Modal -->
  <div class="registry-modal" id="registryModal">
    <div class="registry-terminal">
      <div class="registry-header">
        <div class="registry-title">
          <span class="registry-title-icon">::</span>
          VESSEL REGISTRY // SPACE CAPITAL FLEET DATABASE
        </div>
        <div class="registry-meta">v2.1.4 // SECTOR ALPHA</div>
        <button class="registry-close" id="registryClose" title="Close (ESC)">[X]</button>
      </div>
      <div class="registry-toolbar">
        <div class="registry-toolbar-item">VESSELS: <span class="registry-toolbar-value" id="registryCount">--</span></div>
        <div class="registry-toolbar-item">TIERS: <span class="registry-toolbar-value">S/A/B/C/?</span></div>
        <div class="registry-toolbar-item">SORT: <span class="registry-toolbar-value">TICKER ↑</span></div>
        <div class="registry-toolbar-item">STATUS: <span class="registry-toolbar-value" style="color: var(--hm-cyan);">ONLINE</span></div>
      </div>
      <div class="registry-content">
        <table class="registry-table">
          <thead>
            <tr>
              <th>TICKER</th>
              <th>DESIGNATION</th>
              <th>TIER</th>
              <th>CLASS</th>
              <th>SPECIALTY</th>
              <th>PROFILE</th>
            </tr>
          </thead>
          <tbody id="registryTableBody">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>
      <div class="registry-footer">
        <span>SPACE CAPITAL REGISTRY // FLEET COMMAND SYSTEMS</span>
        <span><kbd>ESC</kbd> to close · Click row to select vessel</span>
      </div>
    </div>
  </div>

  <script>
    // ═══════════════════════════════════════════════════════════════════════════
    // REGISTRY TERMINAL - Bloomberg-style ship reference sheet
    // ═══════════════════════════════════════════════════════════════════════════
    
    (function() {
      const REGISTRY_DATA = {
        ACHR: { name: 'MIDNIGHT', designation: 'AAM-004', class: 'EVTOL', tier: 'B', specialty: 'Air Taxi', tagline: 'Precision carrier class. Silent approach, swift arrival.' },
        ASTS: { name: 'BLUEBIRD', designation: 'COM-003', class: 'RELAY', tier: 'S', specialty: 'Comms', tagline: 'Communication relay hub. The signal never sleeps.' },
        BKSY: { name: 'BLACKSKY', designation: 'RCN-006', class: 'RECON', tier: 'B', specialty: 'Intel', tagline: 'Eyes in the dark. Nothing escapes detection.' },
        COHR: { name: 'PRISM', designation: 'OPT-018', class: 'REFLECTOR', tier: 'A', specialty: 'Optics', tagline: 'Optical specialist. Light is the weapon.' },
        EVEX: { name: 'HORIZON', designation: 'AAM-009', class: 'TRANSPORT', tier: 'C', specialty: 'Cargo', tagline: 'Troop transport. Delivering the payload.' },
        GE: { name: 'SPECTRE', designation: 'IND-019', class: 'BOMBER', tier: 'S', specialty: 'Aerospace', tagline: 'Heavy strike platform. Overwhelming force on call.' },
        GME: { name: 'DIAMOND', designation: 'MEM-010', class: 'DREADNOUGHT', tier: '?', specialty: 'Chaos', tagline: 'Wildcard interceptor. Expect the unexpected.' },
        JOBY: { name: 'SKYWARD', designation: 'EVT-005', class: 'EVTOL', tier: 'A', specialty: 'Air Mobility', tagline: 'Light assault craft. Speed is survival.' },
        KTOS: { name: 'KRATOS', designation: 'DEF-012', class: 'FIGHTER', tier: 'A', specialty: 'Defense', tagline: 'Combat superiority fighter. Dominance through firepower.' },
        LHX: { name: 'HELIX', designation: 'AAM-020', class: 'DRONE', tier: 'A', specialty: 'Electronics', tagline: 'Surveillance drone. Invisible. Omnipresent.' },
        LUNR: { name: 'ODYSSEY', designation: 'LNR-002', class: 'LANDER', tier: 'A', specialty: 'Lunar Ops', tagline: 'Lunar surface specialist. First boots, lasting impact.' },
        PL: { name: 'PLANET', designation: 'SAT-008', class: 'SCOUT', tier: 'A', specialty: 'Imaging', tagline: 'Long-range scout. Charting the unknown.' },
        RDW: { name: 'REDWIRE', designation: 'INF-007', class: 'HAULER', tier: 'B', specialty: 'Infrastructure', tagline: 'Logistics hauler. Supply line lifeline.' },
        RKLB: { name: 'ELECTRON', designation: 'FSC-001', class: 'FLAGSHIP', tier: 'S', specialty: 'Command', tagline: 'Spearhead command ship. Victory follows in its wake.' },
        RTX: { name: 'RAYTHEON', designation: 'DEF-021', class: 'OFFICER', tier: 'S', specialty: 'Defense Prime', tagline: 'Officer command vessel. Strategic precision.' }
      };

      const modal = document.getElementById('registryModal');
      const closeBtn = document.getElementById('registryClose');
      const tableBody = document.getElementById('registryTableBody');
      const countEl = document.getElementById('registryCount');

      function openRegistryTerminal() {
        // Sort alphabetically by ticker
        const tickers = Object.keys(REGISTRY_DATA).sort();
        
        // Update count
        countEl.textContent = tickers.length;
        
        // Render rows
        tableBody.innerHTML = tickers.map(ticker => {
          const ship = REGISTRY_DATA[ticker];
          return `
            <tr data-ticker="${ticker}" onclick="selectRegistryShip('${ticker}')">
              <td>
                <div class="registry-ticker">${ticker}</div>
              </td>
              <td>
                <div class="registry-name">${ship.name}</div>
                <div class="registry-designation">${ship.designation}</div>
              </td>
              <td>
                <span class="registry-tier tier-${ship.tier}">${ship.tier}</span>
              </td>
              <td>
                <div class="registry-class">${ship.class}</div>
              </td>
              <td>
                <div class="registry-specialty">${ship.specialty}</div>
              </td>
              <td>
                <div class="registry-tagline">${ship.tagline}</div>
              </td>
            </tr>
          `;
        }).join('');

        modal.classList.add('open');
        document.body.style.overflow = 'hidden';
      }

      function closeRegistryTerminal() {
        modal.classList.remove('open');
        document.body.style.overflow = '';
      }

      window.selectRegistryShip = function(ticker) {
        // Set as active and navigate to hangar
        if (window.Store) {
          Store.set({ activeTicker: ticker });
        }
        closeRegistryTerminal();
        window.location.href = `hangar.html?ship=${ticker}`;
      };

      // Close handlers
      closeBtn.addEventListener('click', closeRegistryTerminal);
      modal.addEventListener('click', (e) => {
        if (e.target === modal) closeRegistryTerminal();
      });
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('open')) {
          closeRegistryTerminal();
        }
      });

      // Expose for button handler
      window.openRegistryTerminal = openRegistryTerminal;
    })();
  </script>
</body>
</html>
